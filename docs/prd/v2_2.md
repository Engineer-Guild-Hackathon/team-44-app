# **学習発見・興味拡張機能 v2 残り実装計画**

## **1. 概要**

v2機能のMVP実装において、基本的な豆知識表示、クイズ、興味マップの機能は実装済みですが、以下の残り部分について実装を完了させる必要があります。

**情報源ファイルパス:**
- `/docs/prd/v2.md` (v2機能の全体仕様)
- `/functions/src/controllers/discoveryController.ts` (既存API実装)
- `/functions/src/services/discoveryService.ts` (既存サービス実装)
- `/web/store/discoveryStore.ts` (既存状態管理)
- `/web/components/discovery/` (既存コンポーネント)

**書き込み先ファイルパス:**
- `/functions/src/controllers/discoveryController.ts`
- `/functions/src/services/discoveryService.ts`
- `/functions/src/models/types.ts`
- `/web/store/discoveryStore.ts`
- `/web/components/discovery/BasicInterestMap.tsx`
- `/web/app/discovery/page.tsx`
- `/web/app/layout.tsx`

## **2. 抽出された要件**

### **2.1 豆知識インタラクション機能**
- ユーザーが豆知識に対して「いいね」または「詳細表示」を記録できる機能
- インタラクション履歴をデータベースに保存し、将来の推薦に活用

### **2.2 興味マップのインタラクティブ機能**
- 興味マップの各ノードをクリックすると関連する豆知識やクイズを表示
- 新領域提案機能をLLMで実装し、未開拓分野への導線を提供
- **未開拓ジャンルの説明**: ユーザーがまだあまり行っていない学びのジャンルについて、魅力を説明するコンテンツを生成（例: ユーザーが数学を学んでいる場合、哲学や歴史の魅力を紹介）

### **2.3 クイズ提供の最適化**
- 週1-2回の頻度でクイズを提供するロジックの実装
- ユーザーの回答履歴に基づくクイズ難易度調整

### **2.4 データベース最適化**
- user_discoveryコレクションの完全実装
- 学習データと発見データの統合管理

### **2.5 フロントエンド統合強化**
- ログイン時の豆知識表示の安定化
- discoveryページへの自然な導線の実装

## **2.6 未開拓ジャンル発見機能 (新規要件)**
- ユーザーの学習履歴を分析し、まだ触れていない興味深いジャンルを特定
- LLMを使用して、そのジャンルの魅力を説明するコンテンツを生成
- プロトタイプとして、事前定義されたジャンルリストからランダム選択 + LLM説明のハイブリッド方式を採用

## **3. TODOリスト**

### **設計フェーズ**
- [x] APIエンドポイント設計の詳細化（リクエスト/レスポンス形式）
- [x] データベーススキーマの拡張設計
- [x] フロントエンドコンポーネントのインタラクション設計
- [x] エラーハンドリングとバリデーション設計

### **実装フェーズ**
- [ ] バックエンドAPI実装（インタラクション記録、クイズ頻度制御）
- [ ] データベースモデル実装（user_discoveryコレクション）
- [ ] フロントエンド状態管理拡張
- [ ] コンポーネントインタラクティブ機能実装
- [ ] 統合テストとデバッグ

## **4. ファイル構造とコンポーネント役割**

### **バックエンド構造**
- `discoveryController.ts`: APIエンドポイントのハンドリング、認証・バリデーション
- `discoveryService.ts`: ビジネスロジック、LLM連携、データベース操作
- `types.ts`: TypeScript型定義、データベーススキーマ

### **フロントエンド構造**
- `discoveryStore.ts`: 状態管理、API呼び出し、データ同期
- `BasicInterestMap.tsx`: 興味マップの表示とインタラクション
- `page.tsx`: ページレイアウト、コンポーネント統合
- `layout.tsx`: グローバルレイアウト、認証状態管理、ナビゲーション

### **各コンポーネントの役割**
- **Controller**: リクエスト処理、レスポンス生成、エラーハンドリング
- **Service**: データ処理、LLM生成、ビジネスルール適用
- **Store**: 状態管理、API統合、キャッシュ管理
- **Component**: UI表示、ユーザーインタラクション、データ表示
- **Layout**: グローバル機能、認証状態管理、ナビゲーション

## **5. APIエンドポイント設計**

### **POST /discovery/knowledge/interact**
- **目的**: 豆知識へのインタラクションを記録
- **リクエスト**:
  ```typescript
  {
    knowledgeId: string;
    action: 'like' | 'view_detail';
  }
  ```
- **レスポンス**:
  ```typescript
  {
    success: boolean;
    message: string;
  }
  ```

### **GET /discovery/quiz/weekly**
- **目的**: 週次クイズを取得（頻度制御付き）
- **レスポンス**:
  ```typescript
  {
    quiz: QuizItem | null; // null if not time yet
    nextAvailable: Date;
  }
  ```

## **6. データベーススキーマ拡張**

### **user_discoveryコレクション**
```typescript
{
  userId: string;
  knowledgeHistory: {
    itemId: string;
    viewedAt: Timestamp;
    liked: boolean;
    detailViewed: boolean;
  }[];
  quizHistory: {
    itemId: string;
    answeredAt: Timestamp;
    isCorrect: boolean;
    selectedOption: number;
  }[];
  interestMap: {
    [category: string]: {
      level: number;
      lastEngagement: Timestamp;
      itemsViewed: number;
    };
  };
  lastQuizProvided: Timestamp;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

## **7. データフロー**

1. ユーザー認証 → 豆知識取得 → 表示
2. インタラクション → API呼び出し → データベース保存
3. 興味マップクリック → 関連コンテンツ取得 → モーダル表示
4. クイズ要求 → 頻度チェック → 生成/拒否

## **8. フロントエンドインタラクション設計**

### **興味マップノードクリック**
- クリックイベント → モーダル表示
- モーダル内容: 関連豆知識 + クイズ提案
- 閉じるボタンでモーダル解除

### **豆知識インタラクション**
- いいねボタン → API呼び出し → 状態更新
- 詳細表示ボタン → Google検索リンク + API記録

### **クイズ表示**
- 週次チェック → 有効なら表示、無効なら次回日時表示

### **未開拓ジャンル表示**
- ログイン時または興味マップ閲覧時に表示
- 魅力的な説明文とともに提案
- クリックで詳細表示やGoogle検索リンクへ導線
- **プロトタイプ実装**: 事前定義ジャンル（哲学、歴史、芸術、音楽など）からランダム選択 + LLM生成説明

## **9. エラーハンドリング設計**

### **APIエラー**
- 認証エラー: 401 Unauthorized
- バリデーションエラー: 400 Bad Request
- サーバーエラー: 500 Internal Server Error

### **フロントエンドエラー**
- ネットワークエラー: リトライ + エラーメッセージ
- データエラー: フォールバック表示

## **10. テスト計画**

### **ユニットテスト**
- Service層のビジネスロジック
- Componentのインタラクション

### **統合テスト**
- APIエンドポイント
- データベース操作

### **E2Eテスト**
- ユーザーインタラクション全体

## **11. パフォーマンス考慮**

- Firestoreクエリの最適化（インデックス使用）
- APIレスポンスのキャッシュ
- 画像/LLM生成の遅延読み込み

## **12. セキュリティ考慮**

- ユーザーIDの検証
- APIレート制限
- データ暗号化（必要時）

## **13. デプロイメント考慮**

- Firebase Functionsのスケーリング
- Vercelのデプロイ設定
- 環境変数の管理

## **14. ドキュメント更新**

- APIドキュメント更新
- ユーザーガイド更新
- 開発者ドキュメント更新

## **15. 技術的考慮事項**

- データベーススキーマの拡張は後方互換性を維持
- APIレスポンスのエラーハンドリング強化
- フロントエンドの状態管理の一貫性確保

## **16. 実装計画**

| 対応するフォルダ | 対応するファイル | 修正内容の概要 |
| --------------- | --------------- | -------------- |
| functions/src/controllers/ | discoveryController.ts | 豆知識インタラクションAPIの追加（POST /discovery/knowledge/interact） |
| functions/src/services/ | discoveryService.ts | インタラクション記録メソッドの追加、クイズ提供頻度制御の実装 |
| functions/src/models/ | types.ts | user_discoveryコレクションの型定義追加 |
| web/store/ | discoveryStore.ts | インタラクション状態管理の追加、パーソナライズデータ同期 |
| web/components/discovery/ | BasicInterestMap.tsx | ノードクリック時の導線実装 |
| web/components/discovery/ | UntappedKnowledge.tsx | 新規: 未開拓ジャンル説明コンポーネント |
| web/app/discovery/ | page.tsx | 興味マップからのクイズ表示機能追加、未開拓コンテンツ表示 |
| web/app/ | layout.tsx | ログイン時の豆知識表示安定化 |

Q1: クイズの提供頻度を週1-2回とする場合、データベースで最終提供日時を管理する必要がありますが、Firestoreのクエリ効率を考慮した設計で問題ありませんか？

Q2: 興味マップのインタラクティブ機能を追加する場合、ページ遷移せずにモーダル表示とするか、別ページに遷移するかを決定する必要がありますが、どちらがユーザー体験として適切でしょうか？

### **2.6 バッチ処理と事前生成 (新規要件)**
- 豆知識とクイズをバックエンドでバッチ処理し、データベースに事前蓄積
- ユーザーが使用時に遅延を感じないよう、十分なコンテンツを準備
- 定期的にLLMで新規コンテンツを生成し、データベースを更新
- ユーザーの学習履歴を活用したパーソナライズド推薦の実装

## **3. TODOリスト**

### **設計フェーズ**
- [x] APIエンドポイント設計の詳細化（リクエスト/レスポンス形式）
- [x] データベーススキーマの拡張設計
- [x] フロントエンドコンポーネントのインタラクション設計
- [x] エラーハンドリングとバリデーション設計
- [x] バッチ処理アーキテクチャ設計
- [x] パーソナライズ推薦アルゴリズム設計
- [x] 未開拓ジャンル発見機能設計（プロトタイプ向け）

### **実装フェーズ**
- [ ] バックエンドAPI実装（インタラクション記録、クイズ頻度制御）
- [ ] データベースモデル実装（user_discoveryコレクション）
- [ ] バッチ処理サービス実装（定期コンテンツ生成）
- [ ] パーソナライズ推薦ロジック実装
- [ ] 未開拓ジャンル発見機能実装（プロトタイプ）
- [ ] フロントエンド状態管理拡張
- [ ] コンポーネントインタラクティブ機能実装
- [ ] 統合テストとデバッグ

## **4. ファイル構造とコンポーネント役割**

### **バックエンド構造**
- `discoveryController.ts`: APIエンドポイントのハンドリング、認証・バリデーション
- `discoveryService.ts`: ビジネスロジック、LLM連携、データベース操作
- `batchDiscoveryService.ts`: バッチ処理、定期コンテンツ生成、パーソナライズ推薦
- `types.ts`: TypeScript型定義、データベーススキーマ

### **フロントエンド構造**
- `discoveryStore.ts`: 状態管理、API呼び出し、データ同期
- `BasicInterestMap.tsx`: 興味マップの表示とインタラクション
- `page.tsx`: ページレイアウト、コンポーネント統合
- `layout.tsx`: グローバルレイアウト、認証状態管理、ナビゲーション

### **各コンポーネントの役割**
- **Controller**: リクエスト処理、レスポンス生成、エラーハンドリング
- **Service**: データ処理、LLM生成、ビジネスルール適用
- **BatchService**: 定期バッチ処理、コンテンツ蓄積、パーソナライズ
- **Store**: 状態管理、API統合、キャッシュ管理
- **Component**: UI表示、ユーザーインタラクション、データ表示
- **Layout**: グローバル機能、認証状態管理、ナビゲーション

## **5. APIエンドポイント設計**

### **POST /discovery/knowledge/interact**
- **目的**: 豆知識へのインタラクションを記録
- **リクエスト**:
  ```typescript
  {
    knowledgeId: string;
    action: 'like' | 'view_detail';
  }
  ```
- **レスポンス**:
  ```typescript
  {
    success: boolean;
    message: string;
  }
  ```

### **GET /discovery/quiz/weekly**
- **目的**: 週次クイズを取得（頻度制御付き）
- **レスポンス**:
  ```typescript
  {
    quiz: QuizItem | null; // null if not time yet
    nextAvailable: Date;
  }
  ```

### **GET /discovery/personalized-knowledge**
- **目的**: ユーザーパーソナライズド豆知識を取得
- **レスポンス**:
  ```typescript
  {
    knowledge: KnowledgeItem[];
    recommendedCategories: string[];
  }
  ```

### **GET /discovery/untapped-knowledge**
- **目的**: 未開拓ジャンルの魅力を説明する豆知識を取得（プロトタイプ用）
- **レスポンス**:
  ```typescript
  {
    untappedKnowledge: {
      category: string;
      content: string;
      appeal: string; // このジャンルの魅力説明
      googleSearchQuery?: string;
    };
    nextAvailable: Date;
  }
  ```

## **6. データベーススキーマ拡張**

### **user_discoveryコレクション**
```typescript
{
  userId: string;
  knowledgeHistory: {
    itemId: string;
    viewedAt: Timestamp;
    liked: boolean;
    detailViewed: boolean;
  }[];
  quizHistory: {
    itemId: string;
    answeredAt: Timestamp;
    isCorrect: boolean;
    selectedOption: number;
  }[];
  interestMap: {
    [category: string]: {
      level: number;
      lastEngagement: Timestamp;
      itemsViewed: number;
    };
  };
  lastQuizProvided: Timestamp;
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### **knowledge_poolコレクション (新規: 事前生成コンテンツ蓄積)**
```typescript
{
  id: string;
  category: string;
  content: string;
  googleSearchQuery?: string;
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  tags: string[];
  relatedTopics: string[];
  userProfile?: {
    learningSubjects: string[];
    preferredCategories: string[];
  };
  generatedAt: Timestamp;
  isActive: boolean;
  usageCount: number;
}
```

### **quiz_poolコレクション (新規: 事前生成クイズ蓄積)**
```typescript
{
  id: string;
  primaryCategory: string;
  secondaryCategory: string;
  question: string;
  options: string[];
  correctAnswer: number;
  explanation: string;
  googleSearchQuery?: string;
  userProfile?: {
    learningSubjects: string[];
    quizHistory: string[];
  };
  generatedAt: Timestamp;
  isActive: boolean;
  usageCount: number;
}
```

## **7. データフロー**

1. **バッチ処理フロー**:
   - 定期スケジューラ → LLM生成 → knowledge_pool/quiz_pool蓄積
   - ユーザー学習データ分析 → パーソナライズ生成 → プール更新

2. **ユーザー利用フロー**:
   - ユーザー認証 → パーソナライズ推薦 → プールから選択 → 表示
   - インタラクション → 履歴記録 → 推薦アルゴリズム更新

3. **興味マップクリック → 関連コンテンツ取得 → モーダル表示
4. クイズ要求 → 頻度チェック → 生成/拒否

## **8. バッチ処理アーキテクチャ**

### **定期生成スケジュール**
- **豆知識**: 毎日10-20件生成（カテゴリ別）
- **クイズ**: 週3回生成（ユーザープロファイル別）
- **未開拓ジャンル説明**: 週1回生成（全ユーザー共通の魅力説明コンテンツ）
- **パーソナライズ**: ユーザーアクティビティに基づき随時生成

### **生成トリガー**
- Cronジョブ (Firebase Functions)
- ユーザー新規登録時
- 学習データ更新時
- コンテンツ枯渇時

### **遅延回避策**
- 事前生成プールの維持（各カテゴリ最低50件）
- キャッシュレイヤーの導入
- 非同期プリロード

## **9. パーソナライズ推薦アルゴリズム**

### **ユーザープロファイル分析**
- 学習履歴からの興味カテゴリ抽出
- クイズ正答率による難易度調整
- インタラクション履歴からの嗜好分析

### **推薦ロジック**
- 既知分野 + 未開拓分野の組み合わせ生成
- 類似ユーザーからの協調フィルタリング
- LLMによる関連性スコアリング
- **未開拓ジャンル提案**: ユーザーの学習分野と相補的なジャンルを提案（例: 数学学習者には哲学や歴史を提案）

### **A/Bテスト対応**
- 複数アルゴリズムの並行実行
- パフォーマンス指標の収集
- 動的アルゴリズム切り替え

## **10. フロントエンドインタラクション設計**

### **興味マップノードクリック**
- クリックイベント → モーダル表示
- モーダル内容: 関連豆知識 + クイズ提案
- 閉じるボタンでモーダル解除

### **豆知識インタラクション**
- いいねボタン → API呼び出し → 状態更新
- 詳細表示ボタン → Google検索リンク + API記録

### **クイズ表示**
- 週次チェック → 有効なら表示、無効なら次回日時表示

## **11. エラーハンドリング設計**

### **APIエラー**
- 認証エラー: 401 Unauthorized
- バリデーションエラー: 400 Bad Request
- サーバーエラー: 500 Internal Server Error

### **フロントエンドエラー**
- ネットワークエラー: リトライ + エラーメッセージ
- データエラー: フォールバック表示

## **12. テスト計画**

### **ユニットテスト**
- Service層のビジネスロジック
- Componentのインタラクション

### **統合テスト**
- APIエンドポイント
- データベース操作

### **E2Eテスト**
- ユーザーインタラクション全体

## **13. パフォーマンス考慮**

- Firestoreクエリの最適化（インデックス使用）
- APIレスポンスのキャッシュ
- 画像/LLM生成の遅延読み込み

## **14. セキュリティ考慮**

- ユーザーIDの検証
- APIレート制限
- データ暗号化（必要時）

## **15. デプロイメント考慮**

- Firebase Functionsのスケーリング
- Vercelのデプロイ設定
- 環境変数の管理

## **16. ドキュメント更新**

- APIドキュメント更新
- ユーザーガイド更新
- 開発者ドキュメント更新

## **17. 技術的考慮事項**

- データベーススキーマの拡張は後方互換性を維持
- APIレスポンスのエラーハンドリング強化
- フロントエンドの状態管理の一貫性確保

## **18. 実装計画**

| 対応するフォルダ | 対応するファイル | 修正内容の概要 |
| --------------- | --------------- | -------------- |
| functions/src/controllers/ | discoveryController.ts | 豆知識インタラクションAPIの追加（POST /discovery/knowledge/interact） |
| functions/src/services/ | discoveryService.ts | インタラクション記録メソッドの追加、クイズ頻度制御の実装 |
| functions/src/services/ | batchDiscoveryService.ts | 新規: バッチ処理サービス、パーソナライズ推薦ロジック |
| functions/src/models/ | types.ts | user_discoveryコレクションの型定義追加、knowledge_pool/quiz_poolスキーマ |
| web/store/ | discoveryStore.ts | インタラクション状態管理の追加、パーソナライズデータ同期 |
| web/components/discovery/ | BasicInterestMap.tsx | ノードクリック時の導線実装 |
| web/components/discovery/ | UntappedKnowledge.tsx | 新規: 未開拓ジャンル説明コンポーネント |
| web/app/discovery/ | page.tsx | 興味マップからのクイズ表示機能追加、未開拓コンテンツ表示 |
| web/app/ | layout.tsx | ログイン時の豆知識表示安定化 |

Q3: バッチ処理の頻度と量について、初期データとして何件程度のコンテンツを準備すべきでしょうか？ (例: 豆知識1000件、クイズ500件)

**回答**: 初期はデモなので10個程度でいいです。各カテゴリ最低2-3件の豆知識とクイズを準備。

Q4: パーソナライズ推薦において、ユーザーのプライバシー保護とデータ使用について、どのようなポリシーを適用すべきでしょうか？

**回答**: プライバシーは一旦考えず。基本的なデータ使用のみ実施。

Q5: 発見機能で未開拓ジャンルを説明する場合、LLMにどのようなプロンプトを与えるべきでしょうか？

**回答**: 「ユーザーの学習分野[分野名]を考慮し、まだ触れていない[提案ジャンル]について、その魅力を3-4文で説明してください。学習意欲を高めるようなポジティブな表現を使用してください。」

Q6: プロトタイプなので、簡易実装としてどのような機能を優先すべきでしょうか？

**回答**: 1. 未開拓ジャンルのランダム提案（事前定義リストから）、2. 興味マップのノードクリックで関連コンテンツ表示、3. 豆知識のインタラクション記録（いいね/詳細表示）。LLM生成は後回しでモックデータを使用。</content>
<parameter name="filePath">/Users/user/Documents/03_app/team-44-app/docs/prd/v2_2.md
