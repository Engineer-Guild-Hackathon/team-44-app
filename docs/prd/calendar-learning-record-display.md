# カレンダーでlearningRecordを表示する機能 - 実装PRD

## 1. はじめに

### 1.1 本ドキュメントの目的
このPRDは、学習記録（learningRecord）をカレンダー上で表示し、日付をクリックしてポップアップで詳細を確認できる機能の実装仕様を定義します。**このドキュメントの内容に従って実装することで、誰でも同じ成果物を作成できます。**

### 1.2 実装方針
- **段階的実装**: バックエンド → フロントエンドコンポーネント → 統合の順で実装
- **コンポーネント分離**: 再利用可能な独立したコンポーネントとして設計
- **型安全性**: TypeScriptによる厳密な型定義
- **レスポンシブ対応**: モバイル・デスクトップの両方で快適に動作

## 2. 🎯 機能要件

### 2.1 核心機能
1. **カレンダー表示**: 月単位のカレンダーグリッドで学習記録の有無を視覚的に表示
2. **日付クリック**: カレンダーの日付をクリックすると、その日の学習記録一覧をポップアップで表示
3. **学習記録詳細**: ポップアップ内で各学習記録をクリックすると、チャット履歴を含む詳細モーダルを表示
4. **統計表示**: 月間の学習統計（総記録数、総時間、教科数、セッション数）を表示

### 2.2 ユーザーフロー
```
カレンダー表示 → 日付クリック → 学習記録一覧ポップアップ → 記録選択 → 詳細モーダル → チャット履歴確認
```

## 3. 📱 UI/UX仕様

### 3.1 カレンダー日付クリック時のポップアップ仕様

#### 3.1.1 ポップアップ表示方式
**実装方針**: 日付セルクリック時に、その日の学習記録一覧を**モーダルポップアップ**で表示

```
[ポップアップレイアウト]
┌─────────────────────────────────────┐
│ ✕  2025年9月10日の学習記録            │
├─────────────────────────────────────┤
│                                     │
│ 📐 数学 - 二次関数の応用               │ ← クリック可能
│   │ 75分 | 4セッション | レベル3       │
│   │ 最後の学習: 15:30-16:45          │
│   └─ [詳細を見る]                    │
│                                     │
│ 🔤 英語 - 現在完了形                  │ ← クリック可能
│   │ 45分 | 2セッション | レベル2       │
│   │ 最後の学習: 19:00-19:45          │
│   └─ [詳細を見る]                    │
│                                     │
│ [この日の統計]                        │
│ 総学習時間: 120分 | 記録数: 2件       │
└─────────────────────────────────────┘
```

#### 3.1.2 ポップアップ動作仕様
- **表示条件**: 学習記録が1件以上ある日付のみクリック可能
- **表示位置**: 画面中央（モーダル）
- **背景**: 半透明オーバーレイで背景をブロック
- **閉じる方法**: ✕ボタン、背景クリック、ESCキー
- **アニメーション**: フェードイン・アウト（300ms）

### 3.2 詳細モーダル仕様

#### 3.2.1 モーダル構成
```
[詳細モーダルレイアウト]
┌─────────────────────────────────────┐
│ ← 戻る  📐 数学 - 二次関数の応用       │
├─────────────────────────────────────┤
│ [左: セッション一覧] [右: チャット履歴]  │
│                                     │
│ セッション1 (30分)    │ ユーザー: 二次関数とは │
│ 9/10 15:30-16:00    │ AI: 二次関数は...      │
│                     │                      │
│ セッション2 (45分)    │ ユーザー: グラフの描き方 │
│ 9/10 16:15-17:00 ✅ │ AI: まず...           │
│                     │                      │
│ [学習サマリー]        │ ユーザー: 練習問題      │
│ • 基本概念理解完了    │ AI: では...           │
│ • グラフ描画習得     │                      │
│ • 応用問題に挑戦     │ [続きから学習]         │
└─────────────────────────────────────┘
```

## 4. 🔧 実装ファイル構成

### 4.1 新規作成ファイル一覧

| ファイルパス | 目的 | 主要機能 |
|-------------|------|----------|
| `web/components/calendar/CalendarGrid.tsx` | カレンダーグリッド表示 | 月間カレンダー、日付クリック処理、学習記録インジケーター |
| `web/components/calendar/DayRecordsModal.tsx` | 日付クリック時のポップアップ | その日の学習記録一覧表示、詳細モーダル呼び出し |
| `web/components/calendar/LearningRecordDetail.tsx` | 学習記録詳細モーダル | セッション一覧、チャット履歴、学習サマリー表示 |
| `web/components/calendar/CalendarStatistics.tsx` | 統計表示コンポーネント | 月間学習統計の表示 |
| `web/hooks/useCalendar.ts` | カレンダー用カスタムフック | 日付操作、学習記録フィルタリング |
| `web/hooks/useLearningRecords.ts` | 学習記録管理フック | API呼び出し、状態管理 |

### 4.2 修正ファイル一覧

| ファイルパス | 修正内容 | 修正理由 |
|-------------|----------|----------|
| `web/app/calendar/page.tsx` | 完全な実装コードに置き換え | カレンダー機能の統合と表示 |
| `web/types/api.ts` | 型定義の追加（必要に応じて） | 新しいコンポーネント用の型定義 |
| `web/lib/apiClient.ts` | 学習記録取得メソッドの追加（必要に応じて） | 期間指定取得機能 |

## 5. 📋 詳細実装ガイド

### 5.1 ステップ1: CalendarGrid コンポーネント作成

#### 5.1.1 ファイル作成
**ファイル**: `web/components/calendar/CalendarGrid.tsx`

**実装内容**:
- 月間カレンダーのグリッド表示（7×6の42セル）
- 各日付セルに学習記録インジケーター表示
- 日付クリック時のイベントハンドリング
- 前月・次月の移動ボタン
- ローディング状態の表示

**主要props**:
```typescript
interface CalendarGridProps {
  selectedDate: Date
  onDateSelect: (date: Date) => void
  onDateClick: (date: Date, records: LearningRecord[]) => void
  learningRecords: LearningRecord[]
  isLoading: boolean
}
```

**視覚仕様**:
- 学習記録がある日: 右下に緑色のバッジ（記録数表示）
- 今日の日付: 青色のアクセント
- 他の月の日付: グレーアウト
- ホバー時: 薄い背景色

#### 5.1.2 実装ポイント
1. **日付生成ロジック**: 月の第1日曜日から6週間分（42日）を生成
2. **学習記録マッピング**: 日付とlearningRecordのlastStudiedAtを照合
3. **クリック判定**: 学習記録がある日のみクリック可能にする
4. **レスポンシブ**: Tailwind CSSのgridシステムを使用

### 5.2 ステップ2: DayRecordsModal コンポーネント作成

#### 5.2.1 ファイル作成
**ファイル**: `web/components/calendar/DayRecordsModal.tsx`

**実装内容**:
- モーダルベースのポップアップ表示
- 指定日の学習記録一覧表示
- 各記録の基本情報表示（教科、トピック、時間、セッション数）
- 詳細モーダル呼び出し機能
- その日の学習統計表示

**主要props**:
```typescript
interface DayRecordsModalProps {
  isOpen: boolean
  onClose: () => void
  date: Date
  records: LearningRecord[]
  onRecordSelect: (recordId: string) => void
}
```

**表示内容**:
- ヘッダー: 日付と記録件数
- 記録リスト: 教科アイコン、トピック名、学習時間、セッション数、レベル
- フッター: その日の統計（総時間、総記録数）

#### 5.2.2 実装ポイント
1. **モーダル実装**: Portal使用またはfixed positioning
2. **アニメーション**: CSS Transitionでフェード効果
3. **アクセシビリティ**: ESCキー、フォーカストラップ
4. **背景クリック**: オーバーレイクリックで閉じる

### 5.3 ステップ3: LearningRecordDetail コンポーネント作成

#### 5.3.1 ファイル作成
**ファイル**: `web/components/calendar/LearningRecordDetail.tsx`

**実装内容**:
- 大型モーダルでの詳細表示
- 左側: セッション一覧（時間順）
- 右側: 選択セッションのチャット履歴
- 学習サマリーエリア
- 「続きから学習」ボタン

**主要props**:
```typescript
interface LearningRecordDetailProps {
  isOpen: boolean
  onClose: () => void
  recordId: string
  onContinueLearning: (recordId: string) => void
}
```

**レイアウト仕様**:
- 幅: 90vw（最大1200px）
- 高さ: 80vh
- 左パネル: 30%（セッション一覧）
- 右パネル: 70%（チャット履歴）

#### 5.3.2 実装ポイント
1. **データ取得**: recordIdから関連セッションとメッセージを取得
2. **セッション選択**: 左パネルでセッション選択時、右パネルでチャット表示
3. **スクロール**: 各パネル独立したスクロール
4. **チャット表示**: ChatViewコンポーネントの再利用

### 5.4 ステップ4: メインページ統合

#### 5.4.1 ファイル修正
**ファイル**: `web/app/calendar/page.tsx`

**実装内容**:
- 上記3つのコンポーネントを統合
- 状態管理（選択日、モーダル表示状態）
- 学習記録データの取得と管理
- 統計データの計算

**状態管理**:
```typescript
const [selectedDate, setSelectedDate] = useState<Date>(new Date())
const [showDayModal, setShowDayModal] = useState(false)
const [showDetailModal, setShowDetailModal] = useState(false)
const [selectedRecordId, setSelectedRecordId] = useState<string | null>(null)
const [clickedDate, setClickedDate] = useState<Date | null>(null)
```

**イベントハンドリング**:
1. 日付クリック → DayRecordsModal表示
2. 記録選択 → LearningRecordDetail表示
3. モーダル閉じる → 状態リセット

## 6. 🎨 スタイリング仕様

### 6.1 カラーパレット（Librariaテーマ準拠）
- **プライマリー**: `var(--color-primary)`（青系）
- **アクセント**: `var(--color-accent)`（強調色）
- **背景**: `var(--color-bg-light)`（ライト背景）
- **境界**: `var(--color-border)`（境界線）
- **テキスト**: `var(--color-text-light)`（テキスト）

### 6.2 教科別カラーマッピング
```typescript
const subjectColors = {
  '数学': 'bg-blue-100 text-blue-800 border-blue-200',
  '英語': 'bg-green-100 text-green-800 border-green-200',
  '理科': 'bg-purple-100 text-purple-800 border-purple-200',
  '歴史': 'bg-orange-100 text-orange-800 border-orange-200',
  'プログラミング': 'bg-red-100 text-red-800 border-red-200',
  'その他': 'bg-gray-100 text-gray-800 border-gray-200'
}
```

### 6.3 レスポンシブ設計
- **モバイル（～768px）**: シングルカラム、フルスクリーンモーダル
- **タブレット（768px～1024px）**: カレンダー重視、サイドバー調整
- **デスクトップ（1024px～）**: フルレイアウト、大型モーダル

## 7. 📡 APIインテグレーション

### 7.1 必要なAPIエンドポイント
これらのAPIが既に実装されていることを前提とします：

| エンドポイント | メソッド | 目的 |
|---------------|----------|------|
| `/learningRecords/period` | GET | 期間指定での学習記録取得 |
| `/learningRecords/{id}` | GET | 特定学習記録の詳細取得 |
| `/chatSessions` | GET | ユーザーのセッション一覧取得 |
| `/chatSessions/{id}/messages` | GET | セッションのメッセージ取得 |

### 7.2 データフロー
```
1. ページロード → 月間学習記録取得 → カレンダー表示
2. 日付クリック → その日の記録フィルタリング → モーダル表示
3. 記録選択 → 詳細情報取得 → 詳細モーダル表示
4. セッション選択 → メッセージ取得 → チャット履歴表示
```

## 8. 🧪 実装検証手順

### 8.1 コンポーネント単体テスト
1. **CalendarGrid**: 日付生成、クリック処理、インジケーター表示
2. **DayRecordsModal**: モーダル表示、記録一覧、統計表示
3. **LearningRecordDetail**: データ取得、セッション切り替え、チャット表示

### 8.2 統合テスト
1. カレンダー表示 → 学習記録ありの日付をクリック → ポップアップ表示確認
2. ポップアップで記録選択 → 詳細モーダル表示確認
3. 詳細モーダルでセッション選択 → チャット履歴表示確認
4. 各モーダルの閉じる機能確認

### 8.3 ユーザビリティテスト
1. **操作フロー**: カレンダー → 日付クリック → 記録選択 → 詳細確認
2. **レスポンシブ**: モバイル・タブレット・デスクトップでの表示確認
3. **パフォーマンス**: 大量データでの動作確認
4. **アクセシビリティ**: キーボード操作、スクリーンリーダー対応

## 9. 📈 実装優先度

### 9.1 優先度高（必須実装）
1. CalendarGridコンポーネント（基本カレンダー表示）
2. DayRecordsModalコンポーネント（日付クリック時のポップアップ）
3. メインページでの統合と基本的な状態管理

### 9.2 優先度中（推奨実装）
1. LearningRecordDetailコンポーネント（詳細モーダル）
2. CalendarStatisticsコンポーネント（統計表示）
3. カスタムフック（useCalendar, useLearningRecords）

### 9.3 優先度低（拡張機能）
1. アニメーション効果の追加
2. キーボードショートカット
3. エクスポート機能

## 10. 🚀 実装完了の定義

### 10.1 機能完成基準
- [ ] カレンダーで月間の学習記録を視覚的に確認できる
- [ ] 日付をクリックするとその日の学習記録一覧がポップアップで表示される
- [ ] 学習記録をクリックするとチャット履歴を含む詳細がモーダルで表示される
- [ ] すべてのモーダルが適切に開閉される
- [ ] エラーハンドリングが適切に実装されている

### 10.2 品質基準
- [ ] TypeScriptエラーがない
- [ ] レスポンシブデザインが正しく動作する
- [ ] 既存のテストが全て通る
- [ ] パフォーマンスが acceptable（初期表示3秒以内）

### 10.3 ユーザビリティ基準
- [ ] 直感的な操作で学習履歴を確認できる
- [ ] モバイルでも快適に操作できる
- [ ] ローディング状態が適切に表示される
- [ ] エラー状態が分かりやすく表示される

---

**このPRDに従って実装することで、学習記録を効果的にカレンダー表示し、日付クリックでポップアップ表示する機能を完成させることができます。各ステップを順番に実装し、テストを行いながら進めてください。**