# **å­¦ç¿’ç¶™ç¶šã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ å®Ÿè£…è¦æ±‚ä»•æ§˜æ›¸ (v1.2)**

## **1. ã¯ã˜ã‚ã«**

### **1.1 æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ç›®çš„**
æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€v1.mdã§å®šç¾©ã•ã‚ŒãŸå­¦ç¿’ç¶™ç¶šã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’åŸºã«ã€ç¾å®Ÿçš„ã§å®Ÿè£…å¯èƒ½ãªæ©Ÿèƒ½ä»•æ§˜ã‚’ç­–å®šã—ã€ç‰¹ã«ã€Œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‚ç…§ã§ãã‚‹æ©Ÿèƒ½ã€ã«ç„¦ç‚¹ã‚’å½“ã¦ãŸPRDï¼ˆProduct Requirements Documentï¼‰ã¨ã—ã¦ç­–å®šã•ã‚Œã¦ã„ã¾ã™ã€‚

### **1.2 ç¾çŠ¶åˆ†æã¨èª²é¡Œ**
2025å¹´9æœˆ11æ—¥æ™‚ç‚¹ã§ã€ä»¥ä¸‹ã®çŠ¶æ³ãŒç¢ºèªã•ã‚Œã¦ã„ã¾ã™ï¼š

**å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ï¼š**
- âœ… åŸºæœ¬çš„ãªAPIæ§‹é€ ï¼ˆå­¦ç¿’è¨˜éŒ²ã€ãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®šï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«
- âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIï¼ˆãƒªãƒã‚¤ãƒ³ãƒ‰è¨­å®šã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰
- âœ… åŸºæœ¬çš„ãªãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½

**é‡è¦ãªæœªå®Ÿè£…æ©Ÿèƒ½ï¼š**
- âŒ ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®çµ±åˆ
- âŒ å­¦ç¿’è¨˜éŒ²ã®è‡ªå‹•ç”Ÿæˆã¨ä¿å­˜ã‚·ã‚¹ãƒ†ãƒ 
- âŒ PWAãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- âŒ å¾©ç¿’ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®è‡ªå‹•é€šçŸ¥

## **2. ğŸ¯ ã‚³ã‚¢æ©Ÿèƒ½è¨­è¨ˆ: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚·ã‚¹ãƒ†ãƒ **

### **2.1 æ©Ÿèƒ½æ¦‚è¦**
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒAIå¯¾è©±ã§å­¦ç¿’ã—ãŸå†…å®¹ã‚’è‡ªå‹•çš„ã«è¨˜éŒ²ã—ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ä¸Šã§éå»ã®å­¦ç¿’å±¥æ­´ã‚’ç¢ºèªã§ãã‚‹ã‚·ã‚¹ãƒ†ãƒ ã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ç›´æ¥ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‚ç…§ã—ã€å¾©ç¿’ã«æ´»ç”¨ã§ãã‚‹ã€‚

### **2.2 å®Ÿè£…æ–¹é‡ã®æ±ºå®š**

#### **2.2.1 ãƒãƒ£ãƒƒãƒˆä¿å­˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®æˆ¦ç•¥**
ä»¥ä¸‹ã®3ã¤ã®é¸æŠè‚¢ã‚’æ¤œè¨ã—ãŸçµæœã€**ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼**ã‚’æ¡ç”¨ï¼š

**âŒ Option 1: ãƒãƒ£ãƒƒãƒˆçµ‚äº†æ™‚ã®è‡ªå‹•ä¿å­˜**
- å•é¡Œ: çµ‚äº†ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®åˆ¤å®šãŒå›°é›£
- å•é¡Œ: ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã«ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯

**âŒ Option 2: ãƒãƒ£ãƒƒãƒˆé–‹å§‹æ™‚ã®å³åº§ä¿å­˜**
- å•é¡Œ: æ„å‘³ã®ãªã„çŸ­æ™‚é–“ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚‚ä¿å­˜ã•ã‚Œã‚‹
- å•é¡Œ: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆã®å¢—å¤§

**âœ… Option 3: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼ï¼ˆæ¡ç”¨ï¼‰**
```
1. ãƒãƒ£ãƒƒãƒˆé–‹å§‹æ™‚ã«ã€Œä»®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã‚’ä½œæˆ
2. ä¸€å®šæ¡ä»¶ã‚’æº€ãŸã—ãŸæ™‚ç‚¹ã§ã€Œæ­£å¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã€ã«æ˜‡æ ¼
   - æ¡ä»¶: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•° >= 4å› ã‹ã¤ ç¶™ç¶šæ™‚é–“ >= 3åˆ†
3. ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«å¿…ãšçŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆbeforeunloadã‚¤ãƒ™ãƒ³ãƒˆï¼‰
4. æ­£å¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ã¿ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«è¡¨ç¤º
```

#### **2.2.2 ãƒ‡ãƒ¼ã‚¿æ§‹é€ è¨­è¨ˆ**

**æ–°ã—ã„1:Né–¢ä¿‚ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£:**
```typescript
// LearningRecord: å­¦ç¿’ãƒ†ãƒ¼ãƒã®å¤§ããªæ‹¬ã‚Šï¼ˆä¾‹ï¼šã€ŒäºŒæ¬¡é–¢æ•°ã®å­¦ç¿’ã€ï¼‰
interface LearningRecord {
  id: string;
  userId: string;
  subject: string;                    // ä¾‹: "æ•°å­¦"
  topic: string;                      // ä¾‹: "äºŒæ¬¡é–¢æ•°"
  status: "active" | "completed" | "paused";
  totalDuration: number;              // ç´¯è¨ˆå­¦ç¿’æ™‚é–“ï¼ˆåˆ†ï¼‰
  sessionCount: number;               // é–¢é€£ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°
  difficulty: 1 | 2 | 3 | 4 | 5;
  lastStudiedAt: Date;               // æœ€å¾Œã«å­¦ç¿’ã—ãŸæ—¥æ™‚
  summary?: string;                   // å­¦ç¿’ãƒ†ãƒ¼ãƒå…¨ä½“ã®ã‚µãƒãƒªãƒ¼
  keyPoints?: string[];              // é‡è¦ãƒã‚¤ãƒ³ãƒˆ
  isManuallyCreated?: boolean;       // æ‰‹å‹•ä½œæˆãƒ•ãƒ©ã‚°ï¼ˆå°†æ¥æ©Ÿèƒ½ï¼‰
  createdAt: Date;
  updatedAt: Date;
}

// ChatSession: å€‹åˆ¥ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼šã€Œæœ€å¤§å€¤å•é¡Œã®è§£æ³•ã€ï¼‰
interface ChatSession {
  id: string;
  userId: string;
  learningRecordId: string;          // LearningRecordã¸ã®å‚ç…§
  title: string;                     // ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®ã‚¿ã‚¤ãƒˆãƒ«
  status: "draft" | "active" | "completed";
  startedAt: Date;
  completedAt?: Date;
  duration: number;                  // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ™‚é–“ï¼ˆåˆ†ï¼‰
  messageCount: number;
  sessionSummary?: string;           // ã“ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å›ºæœ‰ã®ã‚µãƒãƒªãƒ¼
  createdAt: Date;
  updatedAt: Date;
  messages: ChatMessage[];
}

// ãƒ‡ãƒ¼ã‚¿é–¢ä¿‚: LearningRecord 1 : N ChatSession
// ãƒ¡ãƒªãƒƒãƒˆ:
// - åŒã˜å­¦ç¿’åˆ†é‡ã®è¤‡æ•°å¯¾è©±ã‚’çµ±åˆç®¡ç†
// - å­¦ç¿’é€²æ—ã®ç¶™ç¶šæ€§ã‚’ä¿æŒ
// - ãƒ‡ãƒ¼ã‚¿åˆ†æåŠ¹ç‡ã®å‘ä¸Š
// - æ‰‹å‹•ä½œæˆæ©Ÿèƒ½ã¸ã®æ‹¡å¼µæ€§
```

### **2.3 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºä»•æ§˜**

#### **2.3.1 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã®è¨­è¨ˆï¼ˆæ”¹å–„ç‰ˆï¼‰**
```
[æœˆè¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2025å¹´ 9æœˆ                          â”‚
â”‚ æ—¥ æœˆ ç« æ°´ æœ¨ é‡‘ åœŸ                    â”‚
â”‚  1  2  3  4  5  6  7                 â”‚
â”‚  8  9 â—10 11 12â—13 14                â”‚
â”‚                                     â”‚
â”‚ â—ãƒãƒ¼ã‚¯: å­¦ç¿’è¨˜éŒ²ãŒã‚ã£ãŸæ—¥              â”‚
â”‚ æ•°å­—ãƒãƒƒã‚¸: ãã®æ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚ã®è©³ç´°è¡¨ç¤º]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9æœˆ10æ—¥ã®å­¦ç¿’å±¥æ­´                      â”‚
â”‚                                     â”‚
â”‚ ğŸ“ æ•°å­¦ - äºŒæ¬¡é–¢æ•° (é€²è¡Œä¸­)             â”‚
â”‚   â”‚ ç´¯è¨ˆ75åˆ† | 4ã‚»ãƒƒã‚·ãƒ§ãƒ³              â”‚
â”‚   â”‚ â”œâ”€ åŸºæœ¬æ¦‚å¿µã®ç†è§£ (20åˆ†)           â”‚
â”‚   â”‚ â”œâ”€ æœ€å¤§å€¤ãƒ»æœ€å°å€¤å•é¡Œ (25åˆ†)        â”‚
â”‚   â”‚ â”œâ”€ ã‚°ãƒ©ãƒ•ã®æãæ–¹ (15åˆ†)           â”‚
â”‚   â”‚ â””â”€ åˆ¤åˆ¥å¼ã®å¿œç”¨ (15åˆ†)             â”‚
â”‚   â”‚ [å­¦ç¿’è¨˜éŒ²ã‚’è¦‹ã‚‹] [æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³]   â”‚
â”‚                                     â”‚
â”‚ ğŸ”¤ è‹±èª - ç¾åœ¨å®Œäº†å½¢ (å®Œäº†)             â”‚
â”‚   â”‚ ç´¯è¨ˆ45åˆ† | 2ã‚»ãƒƒã‚·ãƒ§ãƒ³              â”‚
â”‚   â”‚ â”œâ”€ åŸºæœ¬å½¢ã®ç·´ç¿’ (25åˆ†)             â”‚
â”‚   â”‚ â””â”€ å¿œç”¨å•é¡Œ (20åˆ†)                â”‚
â”‚   â”‚ [å¾©ç¿’ã™ã‚‹] [é–¢é€£ãƒˆãƒ”ãƒƒã‚¯]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **2.3.2 å­¦ç¿’è¨˜éŒ²è©³ç´°è¡¨ç¤ºä»•æ§˜**
```
[å­¦ç¿’è¨˜éŒ²è©³ç´°ç”»é¢]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æˆ»ã‚‹  ğŸ“ æ•°å­¦ - äºŒæ¬¡é–¢æ•°              â”‚
â”‚ é€²è¡Œä¸­ | ç´¯è¨ˆ75åˆ† | 4ã‚»ãƒƒã‚·ãƒ§ãƒ³          â”‚
â”‚                                     â”‚
â”‚ [å­¦ç¿’æ¦‚è¦]                            â”‚
â”‚ â€¢ äºŒæ¬¡é–¢æ•°ã®åŸºæœ¬æ¦‚å¿µã¨ã‚°ãƒ©ãƒ•             â”‚
â”‚ â€¢ æœ€å¤§å€¤ãƒ»æœ€å°å€¤ã®æ±‚ã‚æ–¹               â”‚
â”‚ â€¢ åˆ¤åˆ¥å¼ã‚’ç”¨ã„ãŸè§£æ³•                   â”‚
â”‚                                     â”‚
â”‚ [ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´]                       â”‚
â”‚ ğŸ“… 9/10 14:30 åŸºæœ¬æ¦‚å¿µã®ç†è§£ (20åˆ†)     â”‚
â”‚    [ãƒãƒ£ãƒƒãƒˆå±¥æ­´] [ç¶šãã‹ã‚‰å­¦ç¿’]        â”‚
â”‚ ğŸ“… 9/10 16:45 æœ€å¤§å€¤ãƒ»æœ€å°å€¤ (25åˆ†)     â”‚
â”‚    [ãƒãƒ£ãƒƒãƒˆå±¥æ­´] [é¡ä¼¼å•é¡Œ]           â”‚
â”‚ ğŸ“… 9/10 19:15 ã‚°ãƒ©ãƒ•ã®æãæ–¹ (15åˆ†)     â”‚
â”‚    [ãƒãƒ£ãƒƒãƒˆå±¥æ­´] [ç·´ç¿’å•é¡Œ]           â”‚
â”‚                                     â”‚
â”‚ [ã‚¢ã‚¯ã‚·ãƒ§ãƒ³]                          â”‚
â”‚ [æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹] [å¾©ç¿’ãƒ†ã‚¹ãƒˆ]      â”‚
â”‚ [æ‰‹å‹•ã§ãƒ¡ãƒ¢è¿½åŠ ] [å­¦ç¿’å®Œäº†ãƒãƒ¼ã‚¯]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
```
[æœˆè¡¨ç¤ºã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2025å¹´ 9æœˆ                          â”‚
â”‚ æ—¥ æœˆ ç« æ°´ æœ¨ é‡‘ åœŸ                    â”‚
â”‚  1  2  3  4  5  6  7                 â”‚
â”‚  8  9 â—10 11 12â—13 14                â”‚
â”‚                                     â”‚
â”‚ â—ãƒãƒ¼ã‚¯: å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã£ãŸæ—¥        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[æ—¥ä»˜ã‚¯ãƒªãƒƒã‚¯æ™‚ã®è©³ç´°è¡¨ç¤º]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9æœˆ10æ—¥ã®å­¦ç¿’å±¥æ­´                      â”‚
â”‚                                     â”‚
â”‚ ğŸ“š æ•°å­¦ - äºŒæ¬¡é–¢æ•° (15åˆ†)              â”‚
â”‚   â”‚ 14:30-14:45                    â”‚
â”‚   â”‚ [ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¦‹ã‚‹] [å¾©ç¿’ã™ã‚‹]      â”‚
â”‚                                     â”‚
â”‚ ğŸ“š è‹±èª - ç¾åœ¨å®Œäº†å½¢ (23åˆ†)             â”‚
â”‚   â”‚ 19:15-19:38                    â”‚
â”‚   â”‚ [ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¦‹ã‚‹] [å¾©ç¿’ã™ã‚‹]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **2.3.2 ãƒãƒ£ãƒƒãƒˆå±¥æ­´è¡¨ç¤ºä»•æ§˜**
```
[ãƒãƒ£ãƒƒãƒˆå±¥æ­´è©³ç´°ç”»é¢]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† æˆ»ã‚‹  æ•°å­¦ - äºŒæ¬¡é–¢æ•°                  â”‚
â”‚ 2025/09/10 14:30-14:45 (15åˆ†)      â”‚
â”‚                                     â”‚
â”‚ [ãƒãƒ£ãƒƒãƒˆå±¥æ­´]                         â”‚
â”‚ ğŸ‘¤ äºŒæ¬¡é–¢æ•°ã®æœ€å¤§å€¤ãƒ»æœ€å°å€¤ã®æ±‚ã‚æ–¹ãŒ...   â”‚
â”‚ ğŸ¤– äºŒæ¬¡é–¢æ•°ã®æœ€å¤§å€¤ãƒ»æœ€å°å€¤ã‚’æ±‚ã‚ã‚‹éš›... â”‚
â”‚ ğŸ‘¤ åˆ¤åˆ¥å¼ã‚’ä½¿ã†å ´åˆã¯ã©ã†ãªã‚Šã¾ã™ã‹ï¼Ÿ     â”‚
â”‚ ğŸ¤– åˆ¤åˆ¥å¼ã‚’ä½¿ã†æ–¹æ³•ã‚‚èª¬æ˜ã—ã¾ã™ã­...     â”‚
â”‚                                     â”‚
â”‚ [å­¦ç¿’ã‚µãƒãƒªãƒ¼]                         â”‚
â”‚ â€¢ äºŒæ¬¡é–¢æ•°ã®é ‚ç‚¹ã®æ±‚ã‚æ–¹                â”‚
â”‚ â€¢ åˆ¤åˆ¥å¼ã‚’ç”¨ã„ãŸè§£æ³•                   â”‚
â”‚ â€¢ ã‚°ãƒ©ãƒ•ã®è»¸ã¨æœ€å¤§ãƒ»æœ€å°å€¤ã®é–¢ä¿‚         â”‚
â”‚                                     â”‚
â”‚ [å¾©ç¿’ãƒœã‚¿ãƒ³] [é¡ä¼¼å•é¡Œã‚’è§£ã]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
## **3. ğŸš€ å®Ÿè£…ä»•æ§˜æ›¸**

### **3.1 Phase 1: ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã®æ”¹ä¿®**

#### **3.1.1 ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ **

**ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ•ãƒ­ãƒ¼:**
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒãƒ£ãƒƒãƒˆé–‹å§‹
2. AIåˆ†æã§å­¦ç¿’åˆ†é‡ãƒ»ãƒˆãƒ”ãƒƒã‚¯ã‚’æ¨å®š
3. æ—¢å­˜ã®LearningRecordã‚’æ¤œç´¢ï¼ˆåŒä¸€subject+topicï¼‰
   â”œâ”€ è¦‹ã¤ã‹ã£ãŸå ´åˆ: æ—¢å­˜ã®LearningRecordã«æ–°ã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ 
   â””â”€ è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ: æ–°ã—ã„LearningRecordä½œæˆ
4. ChatSessionã‚’ã€Œdraftã€çŠ¶æ…‹ã§ä½œæˆ
5. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°ãƒ»æ™‚é–“æ¡ä»¶ã‚’æº€ãŸã—ãŸã‚‰ã€Œactiveã€ã«æ˜‡æ ¼
6. ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³é‡è¤‡é˜²æ­¢ãƒ¡ã‚«ãƒ‹ã‚ºãƒ :**
```typescript
// ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆæ™‚ã®ç«¶åˆãƒã‚§ãƒƒã‚¯
async function createOrAttachSession(userId: string, estimatedSubject: string, estimatedTopic: string) {
  // åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼ˆFirestore Transactionä½¿ç”¨ï¼‰
  return db.runTransaction(async (transaction) => {
    // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªLearningRecordã‚’æ¤œç´¢
    const existingRecord = await findActiveLearningRecord(userId, estimatedSubject, estimatedTopic);

    if (existingRecord) {
      // æ—¢å­˜è¨˜éŒ²ã«æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      return createSessionForExistingRecord(existingRecord.id, userId, transaction);
    } else {
      // æ–°ã—ã„å­¦ç¿’è¨˜éŒ²ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
      return createNewLearningRecordWithSession(userId, estimatedSubject, estimatedTopic, transaction);
    }
  });
}
```

#### **3.1.2 ChatController ã®å®Œå…¨æ”¹ä¿®**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `functions/src/controllers/chatController.ts`
```typescript
import { Request, Response } from "express";
import { ChatService } from "../services/chatService";
import { LearningRecordService } from "../services/learningRecordService";

const chatService = new ChatService();
const learningRecordService = new LearningRecordService();

export async function createSession(req: Request, res: Response) {
  try {
    const { initialMessage } = req.body;
    const userId = req.user?.uid || "anonymous";

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰AIåˆ†æã§å­¦ç¿’åˆ†é‡ã‚’æ¨å®š
    const estimation = await learningRecordService.estimateSubjectAndTopic(initialMessage);

    // ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆæ—¢å­˜è¨˜éŒ²ã¸ã®è¿½åŠ  or æ–°è¦ä½œæˆï¼‰
    const result = await chatService.createSmartSession(
      userId,
      estimation.subject,
      estimation.topic,
      initialMessage
    );

    res.json({
      success: true,
      sessionId: result.sessionId,
      learningRecordId: result.learningRecordId,
      isNewLearningRecord: result.isNewLearningRecord
    });
  } catch (error) {
    console.error("Error creating session:", error);
    res.status(500).json({
      success: false,
      error: "Failed to create session"
    });
  }
}

export async function postMessage(req: Request, res: Response) {
  try {
    const { sessionId } = req.params;
    const { message } = req.body;
    const userId = req.user?.uid || "anonymous";

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°
    const response = await chatService.sendMessageWithStateManagement(sessionId, message, userId);

    res.json({
      success: true,
      response: response.aiResponse,
      sessionId,
      sessionStatus: response.sessionStatus,
      learningRecordUpdated: response.learningRecordUpdated
    });
  } catch (error) {
    console.error("Error posting message:", error);
    res.status(500).json({
      success: false,
      error: "Failed to process message"
    });
  }
}

// æ‰‹å‹•å­¦ç¿’è¨˜éŒ²ä½œæˆAPIï¼ˆå°†æ¥æ©Ÿèƒ½ï¼‰
export async function createManualLearningRecord(req: Request, res: Response) {
  try {
    const { subject, topic, summary, keyPoints } = req.body;
    const userId = req.user?.uid || "anonymous";

    const record = await learningRecordService.createManualRecord({
      userId,
      subject,
      topic,
      summary,
      keyPoints,
      isManuallyCreated: true
    });

    res.json({
      success: true,
      learningRecord: record
    });
  } catch (error) {
    console.error("Error creating manual learning record:", error);
    res.status(500).json({
      success: false,
      error: "Failed to create manual learning record"
    });
  }
}

// ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†å‡¦ç†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾å¿œï¼‰
export async function completeSession(req: Request, res: Response) {
  try {
    const { sessionId } = req.params;
    const userId = req.user?.uid || "anonymous";

    await chatService.gracefulSessionCompletion(sessionId, userId);

    res.json({
      success: true,
      message: "Session completed successfully"
    });
  } catch (error) {
    console.error("Error completing session:", error);
    res.status(500).json({
      success: false,
      error: "Failed to complete session"
    });
  }
}
```

### **3.2 Phase 2: LearningRecordService ä¸­å¿ƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**

#### **3.2.1 LearningRecordService ã®å®Ÿè£…**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `functions/src/services/learningRecordService.ts`
```typescript
import * as admin from "firebase-admin";
import { LLMService } from "./llm/llmService";

const db = admin.firestore();
const llmService = new LLMService();

export class LearningRecordService {
  /**
   * åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å­¦ç¿’åˆ†é‡ã¨ãƒˆãƒ”ãƒƒã‚¯ã‚’æ¨å®š
   */
  async estimateSubjectAndTopic(initialMessage: string): Promise<{
    subject: string;
    topic: string;
    confidence: number;
  }> {
    const prompt = `
ä»¥ä¸‹ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å­¦ç¿’åˆ†é‡ã¨ãƒˆãƒ”ãƒƒã‚¯ã‚’æ¨å®šã—ã¦ãã ã•ã„ï¼š

ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: "${initialMessage}"

å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰:
{
  "subject": "å­¦ç¿’åˆ†é‡ï¼ˆæ•°å­¦ã€è‹±èªã€ç‰©ç†ã€åŒ–å­¦ã€ç”Ÿç‰©ã€å›½èªã€ç¤¾ä¼šã€ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ç­‰ï¼‰",
  "topic": "å…·ä½“çš„ãªãƒˆãƒ”ãƒƒã‚¯ï¼ˆäºŒæ¬¡é–¢æ•°ã€ç¾åœ¨å®Œäº†å½¢ã€åŠ›å­¦ç­‰ï¼‰",
  "confidence": ä¿¡é ¼åº¦ï¼ˆ0.0-1.0ï¼‰
}
`;

    try {
      const response = await llmService.generateResponse(prompt);
      const result = JSON.parse(response);
      return {
        subject: result.subject || "ä¸€èˆ¬å­¦ç¿’",
        topic: result.topic || "AIå¯¾è©±",
        confidence: result.confidence || 0.5
      };
    } catch (error) {
      console.error("Error estimating subject and topic:", error);
      return {
        subject: "ä¸€èˆ¬å­¦ç¿’",
        topic: "AIå¯¾è©±",
        confidence: 0.3
      };
    }
  }

  /**
   * ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå­¦ç¿’è¨˜éŒ²ã‚’æ¤œç´¢ï¼ˆåŒä¸€subject+topicï¼‰
   */
  async findActiveLearningRecord(
    userId: string,
    subject: string,
    topic: string
  ): Promise<any | null> {
    try {
      const snapshot = await db
        .collection("learningRecords")
        .where("userId", "==", userId)
        .where("subject", "==", subject)
        .where("topic", "==", topic)
        .where("status", "==", "active")
        .limit(1)
        .get();

      if (snapshot.empty) {
        return null;
      }

      const doc = snapshot.docs[0];
      return { id: doc.id, ...doc.data() };
    } catch (error) {
      console.error("Error finding active learning record:", error);
      return null;
    }
  }

  /**
   * æ–°ã—ã„å­¦ç¿’è¨˜éŒ²ã‚’ä½œæˆ
   */
  async createNewLearningRecord(
    userId: string,
    subject: string,
    topic: string,
    isManuallyCreated: boolean = false
  ): Promise<string> {
    const recordRef = db.collection("learningRecords").doc();

    const recordData = {
      id: recordRef.id,
      userId,
      subject,
      topic,
      status: "active",
      totalDuration: 0,
      sessionCount: 0,
      difficulty: 3, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
      lastStudiedAt: new Date(),
      isManuallyCreated,
      createdAt: new Date(),
      updatedAt: new Date()
    };

    await recordRef.set(recordData);
    return recordRef.id;
  }

  /**
   * å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³è¿½åŠ æ™‚ï¼‰
   */
  async updateLearningRecordOnSessionComplete(
    learningRecordId: string,
    sessionDuration: number,
    sessionSummary?: string
  ): Promise<void> {
    const recordRef = db.collection("learningRecords").doc(learningRecordId);

    await recordRef.update({
      totalDuration: admin.firestore.FieldValue.increment(sessionDuration),
      sessionCount: admin.firestore.FieldValue.increment(1),
      lastStudiedAt: new Date(),
      updatedAt: new Date()
    });

    // AIåˆ†æã§å­¦ç¿’è¨˜éŒ²ã®ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    await this.updateLearningRecordSummary(learningRecordId);
  }

  /**
   * å­¦ç¿’è¨˜éŒ²ã®ã‚µãƒãƒªãƒ¼ã‚’AIåˆ†æã§æ›´æ–°
   */
  private async updateLearningRecordSummary(learningRecordId: string): Promise<void> {
    try {
      // é–¢é€£ã™ã‚‹å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—
      const sessionsSnapshot = await db
        .collection("chatSessions")
        .where("learningRecordId", "==", learningRecordId)
        .where("status", "==", "completed")
        .get();

      if (sessionsSnapshot.empty) return;

      // å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å†…å®¹ã‚’çµ±åˆã—ã¦AIåˆ†æ
      const allSessionContent = sessionsSnapshot.docs.map(doc => {
        const session = doc.data();
        return `ã‚»ãƒƒã‚·ãƒ§ãƒ³: ${session.title}\nå†…å®¹: ${session.sessionSummary || ''}`;
      }).join('\n\n');

      const analysisPrompt = `
ä»¥ä¸‹ã®å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¾¤ã‚’åˆ†æã—ã¦ã€å­¦ç¿’è¨˜éŒ²ã®ã‚µãƒãƒªãƒ¼ã¨é‡è¦ãƒã‚¤ãƒ³ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ï¼š

${allSessionContent}

å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰:
{
  "summary": "å­¦ç¿’ãƒ†ãƒ¼ãƒå…¨ä½“ã®è¦ç´„ï¼ˆ200æ–‡å­—ç¨‹åº¦ï¼‰",
  "keyPoints": ["é‡è¦ãƒã‚¤ãƒ³ãƒˆ1", "é‡è¦ãƒã‚¤ãƒ³ãƒˆ2", "é‡è¦ãƒã‚¤ãƒ³ãƒˆ3"],
  "difficulty": 1ã‹ã‚‰5ã®é›£æ˜“åº¦è©•ä¾¡
}
`;

      const analysisResponse = await llmService.generateResponse(analysisPrompt);
      const analysis = JSON.parse(analysisResponse);

      // å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°
      await db.collection("learningRecords").doc(learningRecordId).update({
        summary: analysis.summary,
        keyPoints: analysis.keyPoints,
        difficulty: analysis.difficulty,
        updatedAt: new Date()
      });
    } catch (error) {
      console.error("Error updating learning record summary:", error);
    }
  }

  /**
   * æ‰‹å‹•å­¦ç¿’è¨˜éŒ²ä½œæˆï¼ˆå°†æ¥æ©Ÿèƒ½ï¼‰
   */
  async createManualRecord(data: {
    userId: string;
    subject: string;
    topic: string;
    summary?: string;
    keyPoints?: string[];
  }): Promise<any> {
    const recordId = await this.createNewLearningRecord(
      data.userId,
      data.subject,
      data.topic,
      true // isManuallyCreated = true
    );

    if (data.summary || data.keyPoints) {
      await db.collection("learningRecords").doc(recordId).update({
        summary: data.summary,
        keyPoints: data.keyPoints,
        updatedAt: new Date()
      });
    }

    return recordId;
  }

  /**
   * å­¦ç¿’è¨˜éŒ²ä¸€è¦§å–å¾—ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ï¼‰
   */
  async getLearningRecordsForPeriod(
    userId: string,
    startDate: Date,
    endDate: Date
  ): Promise<any[]> {
    try {
      const snapshot = await db
        .collection("learningRecords")
        .where("userId", "==", userId)
        .where("lastStudiedAt", ">=", startDate)
        .where("lastStudiedAt", "<=", endDate)
        .orderBy("lastStudiedAt", "desc")
        .get();

      return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
    } catch (error) {
      console.error("Error getting learning records:", error);
      return [];
    }
  }
}
```

#### **3.2.2 ChatService ã®æ”¹ä¿®ï¼ˆ1:Nå¯¾å¿œï¼‰**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `functions/src/services/chatService.ts`
```typescript
import * as admin from "firebase-admin";
import { LearningRecordService } from "./learningRecordService";

const db = admin.firestore();
const learningRecordService = new LearningRecordService();

export class ChatService {
  /**
   * ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆï¼ˆæ—¢å­˜å­¦ç¿’è¨˜éŒ²ã¸ã®è¿½åŠ  or æ–°è¦ä½œæˆï¼‰
   */
  async createSmartSession(
    userId: string,
    estimatedSubject: string,
    estimatedTopic: string,
    initialMessage: string
  ): Promise<{
    sessionId: string;
    learningRecordId: string;
    isNewLearningRecord: boolean;
  }> {
    return db.runTransaction(async (transaction) => {
      // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå­¦ç¿’è¨˜éŒ²ã‚’æ¤œç´¢
      const existingRecord = await learningRecordService.findActiveLearningRecord(
        userId,
        estimatedSubject,
        estimatedTopic
      );

      let learningRecordId: string;
      let isNewLearningRecord: boolean;

      if (existingRecord) {
        // æ—¢å­˜ã®å­¦ç¿’è¨˜éŒ²ã‚’ä½¿ç”¨
        learningRecordId = existingRecord.id;
        isNewLearningRecord = false;
      } else {
        // æ–°ã—ã„å­¦ç¿’è¨˜éŒ²ã‚’ä½œæˆ
        learningRecordId = await learningRecordService.createNewLearningRecord(
          userId,
          estimatedSubject,
          estimatedTopic
        );
        isNewLearningRecord = true;
      }

      // æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
      const sessionRef = db.collection("chatSessions").doc();
      const sessionData = {
        id: sessionRef.id,
        userId,
        learningRecordId,
        title: `${estimatedTopic}ã«é–¢ã™ã‚‹å¯¾è©±`,
        status: "draft",
        startedAt: new Date(),
        messageCount: 0,
        duration: 0,
        createdAt: new Date(),
        updatedAt: new Date(),
        messages: []
      };

      transaction.set(sessionRef, sessionData);

      return {
        sessionId: sessionRef.id,
        learningRecordId,
        isNewLearningRecord
      };
    });
  }

  /**
   * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã¨çŠ¶æ…‹ç®¡ç†
   */
  async sendMessageWithStateManagement(
    sessionId: string,
    message: string,
    userId: string
  ): Promise<{
    aiResponse: string;
    sessionStatus: string;
    learningRecordUpdated: boolean;
  }> {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦AIå¿œç­”ã‚’å–å¾—
    const aiResponse = await this.getAIResponse(sessionId, message);

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
    await this.updateSessionActivity(sessionId);

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    const session = await this.getSessionById(sessionId);
    let learningRecordUpdated = false;

    if (session && session.status === "draft") {
      const shouldPromote = await this.shouldPromoteSession(session);
      if (shouldPromote) {
        await this.promoteToActiveSession(sessionId);
        learningRecordUpdated = true;
      }
    }

    return {
      aiResponse,
      sessionStatus: session?.status || "unknown",
      learningRecordUpdated
    };
  }

  /**
   * å„ªé›…ãªã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºå¯¾å¿œï¼‰
   */
  async gracefulSessionCompletion(sessionId: string, userId: string): Promise<void> {
    const session = await this.getSessionById(sessionId);

    if (!session || session.userId !== userId) {
      throw new Error("Session not found or access denied");
    }

    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹ã«å¿œã˜ã¦å‡¦ç†
    if (session.status === "active" && session.messageCount >= 2) {
      // æ„å‘³ã®ã‚ã‚‹ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦å®Œäº†å‡¦ç†
      await this.completeSession(sessionId);

      // å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°
      await learningRecordService.updateLearningRecordOnSessionComplete(
        session.learningRecordId,
        session.duration,
        session.sessionSummary
      );
    } else if (session.status === "draft") {
      // ãƒ‰ãƒ©ãƒ•ãƒˆçŠ¶æ…‹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯å‰Šé™¤
      await this.deleteSession(sessionId);
    }
  }

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆæ„å‘³ã®ãªã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”¨ï¼‰
   */
  private async deleteSession(sessionId: string): Promise<void> {
    await db.collection("chatSessions").doc(sessionId).delete();
  }

  // ãã®ä»–ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯æ—¢å­˜å®Ÿè£…ã‚’ç¶™æ‰¿...
}
```
  }

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å®Œäº†çŠ¶æ…‹ã«å¤‰æ›´
   */
  async completeSession(sessionId: string): Promise<any> {
    const sessionRef = db.collection("chatSessions").doc(sessionId);
    const sessionDoc = await sessionRef.get();

    if (!sessionDoc.exists) {
      throw new Error("Session not found");
    }

    const session = sessionDoc.data();
    const now = new Date();
    const durationMinutes = (now.getTime() - session.startedAt.toDate().getTime()) / (1000 * 60);

    await sessionRef.update({
      status: "completed",
      completedAt: now,
      duration: Math.round(durationMinutes),
      updatedAt: now
    });

    return { ...session, status: "completed", completedAt: now, duration: Math.round(durationMinutes) };
  }
}
```

### **3.2 Phase 2: å­¦ç¿’è¨˜éŒ²è‡ªå‹•ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ **

#### **3.2.1 LearningRecordService ã®å®Ÿè£…**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `functions/src/services/learningRecordService.ts`
```typescript
import * as admin from "firebase-admin";
import { LLMService } from "./llm/llmService";

const db = admin.firestore();
const llmService = new LLMService();

export class LearningRecordService {
  /**
   * ãƒ‰ãƒ©ãƒ•ãƒˆå­¦ç¿’è¨˜éŒ²ã‚’ä½œæˆ
   */
  async createDraftRecord(sessionId: string, userId: string): Promise<void> {
    const recordRef = db.collection("learningRecords").doc();

    await recordRef.set({
      id: recordRef.id,
      userId,
      sessionId,
      status: "draft",
      createdAt: new Date(),
      updatedAt: new Date()
    });
  }

  /**
   * ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã«å­¦ç¿’è¨˜éŒ²ã‚’å®Œæˆ
   */
  async finalizeRecord(sessionId: string, session: any): Promise<void> {
    try {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’åˆ†æ
      const analysis = await this.analyzeSessionContent(session.messages);

      // å­¦ç¿’è¨˜éŒ²ã‚’æ›´æ–°
      const recordQuery = await db
        .collection("learningRecords")
        .where("sessionId", "==", sessionId)
        .where("status", "==", "draft")
        .limit(1)
        .get();

      if (!recordQuery.empty) {
        const recordDoc = recordQuery.docs[0];
        await recordDoc.ref.update({
          subject: analysis.subject,
          topic: analysis.topic,
          summary: analysis.summary,
          keyPoints: analysis.keyPoints,
          difficulty: analysis.difficulty,
          duration: session.duration,
          status: "completed",
          completedAt: session.completedAt,
          updatedAt: new Date()
        });
      }
    } catch (error) {
      console.error("Error finalizing learning record:", error);
    }
  }

  /**
   * AIã‚’ä½¿ã£ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…å®¹ã‚’åˆ†æ
   */
  private async analyzeSessionContent(messages: any[]): Promise<{
    subject: string;
    topic: string;
    summary: string;
    keyPoints: string[];
    difficulty: number;
  }> {
    const conversationText = messages
      .map(msg => `${msg.role}: ${msg.parts[0]?.text || ''}`)
      .join('\n');

    const prompt = `
ä»¥ä¸‹ã®å­¦ç¿’å¯¾è©±ã‚’åˆ†æã—ã¦ã€JSONå½¢å¼ã§æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š

å¯¾è©±å†…å®¹:
${conversationText}

å‡ºåŠ›å½¢å¼:
{
  "subject": "å­¦ç¿’åˆ†é‡ï¼ˆä¾‹ï¼šæ•°å­¦ã€è‹±èªã€ç‰©ç†ãªã©ï¼‰",
  "topic": "å…·ä½“çš„ãªãƒˆãƒ”ãƒƒã‚¯ï¼ˆä¾‹ï¼šäºŒæ¬¡é–¢æ•°ã€ç¾åœ¨å®Œäº†å½¢ãªã©ï¼‰",
  "summary": "å­¦ç¿’å†…å®¹ã®è¦ç´„ï¼ˆ100æ–‡å­—ç¨‹åº¦ï¼‰",
  "keyPoints": ["é‡è¦ãƒã‚¤ãƒ³ãƒˆ1", "é‡è¦ãƒã‚¤ãƒ³ãƒˆ2", "é‡è¦ãƒã‚¤ãƒ³ãƒˆ3"],
  "difficulty": 1ã‹ã‚‰5ã®é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«
}
`;

    try {
      const response = await llmService.generateResponse(prompt);
      return JSON.parse(response);
    } catch (error) {
      console.error("Error analyzing session content:", error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
      return {
        subject: "ä¸€èˆ¬å­¦ç¿’",
        topic: "AIå¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³",
        summary: "AI ã¨ã®å¯¾è©±ã‚’é€šã˜ãŸå­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³",
        keyPoints: ["AIå¯¾è©±å­¦ç¿’"],
        difficulty: 3
      };
    }
  }
}
```

### **3.3 Phase 3: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çµ±åˆUI**

#### **3.3.1 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã®æ”¹ä¿®**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/app/calendar/page.tsx`
```typescript
'use client'

import { useState, useEffect } from 'react'
import { CalendarGrid } from '../../components/calendar/CalendarGrid'
import { LearningSessionList } from '../../components/calendar/LearningSessionList'
import { ChatHistoryModal } from '../../components/calendar/ChatHistoryModal'

interface LearningRecord {
  id: string
  sessionId: string
  subject: string
  topic: string
  summary: string
  keyPoints: string[]
  difficulty: number
  duration: number
  completedAt: Date
}

export default function CalendarPage() {
  const [selectedDate, setSelectedDate] = useState<Date>(new Date())
  const [learningRecords, setLearningRecords] = useState<LearningRecord[]>([])
  const [selectedSession, setSelectedSession] = useState<string | null>(null)
  const [isLoading, setIsLoading] = useState(false)

  // æœˆã®å­¦ç¿’è¨˜éŒ²ã‚’å–å¾—
  const fetchMonthlyRecords = async (date: Date) => {
    setIsLoading(true)
    try {
      const year = date.getFullYear()
      const month = date.getMonth()
      const startDate = new Date(year, month, 1)
      const endDate = new Date(year, month + 1, 0)

      const response = await fetch(
        `${process.env.NEXT_PUBLIC_API_BASE_URL}/learningRecords?` +
        `startDate=${startDate.toISOString()}&endDate=${endDate.toISOString()}`
      )

      if (response.ok) {
        const data = await response.json()
        setLearningRecords(data.records || [])
      }
    } catch (error) {
      console.error('Failed to fetch learning records:', error)
    } finally {
      setIsLoading(false)
    }
  }

  // é¸æŠæ—¥ã®å­¦ç¿’è¨˜éŒ²ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  const getDayRecords = (date: Date) => {
    return learningRecords.filter(record => {
      const recordDate = new Date(record.completedAt)
      return recordDate.toDateString() === date.toDateString()
    })
  }

  // æ—¥ä»˜å¤‰æ›´æ™‚ã«è¨˜éŒ²ã‚’å–å¾—
  useEffect(() => {
    fetchMonthlyRecords(selectedDate)
  }, [selectedDate.getMonth(), selectedDate.getFullYear()])

  return (
    <div className="min-h-screen bg-gray-50 py-8">
      <div className="max-w-6xl mx-auto px-4">
        <h1 className="text-3xl font-bold text-gray-900 mb-8">å­¦ç¿’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
          {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ */}
          <div className="lg:col-span-2">
            <CalendarGrid
              selectedDate={selectedDate}
              onDateSelect={setSelectedDate}
              learningRecords={learningRecords}
              isLoading={isLoading}
            />
          </div>

          {/* é¸æŠæ—¥ã®å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ */}
          <div className="lg:col-span-1">
            <LearningSessionList
              date={selectedDate}
              records={getDayRecords(selectedDate)}
              onSessionSelect={setSelectedSession}
            />
          </div>
        </div>

        {/* ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« */}
        {selectedSession && (
          <ChatHistoryModal
            sessionId={selectedSession}
            onClose={() => setSelectedSession(null)}
          />
        )}
      </div>
    </div>
  )
}
```
#### **3.3.2 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/components/calendar/CalendarGrid.tsx`
```typescript
'use client'

import { useState } from 'react'

interface CalendarGridProps {
  selectedDate: Date
  onDateSelect: (date: Date) => void
  learningRecords: any[]
  isLoading: boolean
}

export function CalendarGrid({ selectedDate, onDateSelect, learningRecords, isLoading }: CalendarGridProps) {
  const currentMonth = selectedDate.getMonth()
  const currentYear = selectedDate.getFullYear()
  const firstDayOfMonth = new Date(currentYear, currentMonth, 1)
  const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0)
  const startDate = new Date(firstDayOfMonth)
  startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay())

  const days = []
  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate)
    date.setDate(date.getDate() + i)
    days.push(date)
  }

  // æ—¥ä»˜ã«å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  const hasLearningRecord = (date: Date) => {
    return learningRecords.some(record => {
      const recordDate = new Date(record.completedAt)
      return recordDate.toDateString() === date.toDateString()
    })
  }

  // æ—¥ä»˜ã®å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚’å–å¾—
  const getSessionCount = (date: Date) => {
    return learningRecords.filter(record => {
      const recordDate = new Date(record.completedAt)
      return recordDate.toDateString() === date.toDateString()
    }).length
  }

  const moveMonth = (direction: number) => {
    const newDate = new Date(selectedDate)
    newDate.setMonth(newDate.getMonth() + direction)
    onDateSelect(newDate)
  }

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="flex items-center justify-between mb-6">
        <button
          onClick={() => moveMonth(-1)}
          className="p-2 hover:bg-gray-100 rounded-lg"
        >
          â† å‰æœˆ
        </button>
        <h2 className="text-xl font-semibold text-gray-900">
          {currentYear}å¹´ {currentMonth + 1}æœˆ
        </h2>
        <button
          onClick={() => moveMonth(1)}
          className="p-2 hover:bg-gray-100 rounded-lg"
        >
          æ¬¡æœˆ â†’
        </button>
      </div>

      {/* æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <div className="grid grid-cols-7 gap-1 mb-2">
        {['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map(day => (
          <div key={day} className="p-2 text-center text-sm font-medium text-gray-500">
            {day}
          </div>
        ))}
      </div>

      {/* æ—¥ä»˜ã‚°ãƒªãƒƒãƒ‰ */}
      <div className="grid grid-cols-7 gap-1">
        {days.map((date, index) => {
          const isCurrentMonth = date.getMonth() === currentMonth
          const isSelected = date.toDateString() === selectedDate.toDateString()
          const isToday = date.toDateString() === new Date().toDateString()
          const hasRecord = hasLearningRecord(date)
          const sessionCount = getSessionCount(date)

          return (
            <button
              key={index}
              onClick={() => onDateSelect(date)}
              className={`
                relative p-2 h-16 text-left rounded-lg transition-colors
                ${isCurrentMonth ? 'text-gray-900' : 'text-gray-300'}
                ${isSelected ? 'bg-blue-100 border-2 border-blue-500' : 'hover:bg-gray-50'}
                ${isToday ? 'bg-blue-50' : ''}
              `}
            >
              <div className="text-sm font-medium">{date.getDate()}</div>

              {/* å­¦ç¿’è¨˜éŒ²ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */}
              {hasRecord && (
                <div className="absolute bottom-1 right-1">
                  <div className="flex items-center justify-center w-5 h-5 bg-green-500 text-white text-xs rounded-full">
                    {sessionCount}
                  </div>
                </div>
              )}

              {/* ä»Šæ—¥ã®ãƒãƒ¼ã‚«ãƒ¼ */}
              {isToday && (
                <div className="absolute bottom-1 left-1 w-2 h-2 bg-blue-500 rounded-full"></div>
              )}
            </button>
          )
        })}
      </div>

      {/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */}
      {isLoading && (
        <div className="absolute inset-0 bg-white bg-opacity-75 flex items-center justify-center rounded-lg">
          <div className="text-gray-500">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      )}
    </div>
  )
}
```

#### **3.3.3 å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/components/calendar/LearningSessionList.tsx`
```typescript
'use client'

interface LearningSessionListProps {
  date: Date
  records: any[]
  onSessionSelect: (sessionId: string) => void
}

export function LearningSessionList({ date, records, onSessionSelect }: LearningSessionListProps) {
  const formatTime = (dateStr: string) => {
    const date = new Date(dateStr)
    return date.toLocaleTimeString('ja-JP', {
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  const getSubjectIcon = (subject: string) => {
    const icons = {
      'æ•°å­¦': 'ğŸ“',
      'è‹±èª': 'ğŸ”¤',
      'ç‰©ç†': 'âš›ï¸',
      'åŒ–å­¦': 'ğŸ§ª',
      'ç”Ÿç‰©': 'ğŸ§¬',
      'å›½èª': 'ğŸ“š',
      'ç¤¾ä¼š': 'ğŸŒ',
      'æ­´å²': 'ğŸ“œ',
      'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°': 'ğŸ’»',
      'ãã®ä»–': 'ğŸ“–'
    }
    return icons[subject] || icons['ãã®ä»–']
  }

  const getDifficultyColor = (difficulty: number) => {
    const colors = {
      1: 'bg-green-100 text-green-800',
      2: 'bg-blue-100 text-blue-800',
      3: 'bg-yellow-100 text-yellow-800',
      4: 'bg-orange-100 text-orange-800',
      5: 'bg-red-100 text-red-800'
    }
    return colors[difficulty] || colors[3]
  }

  return (
    <div className="bg-white rounded-lg shadow-lg p-6">
      <h3 className="text-lg font-semibold text-gray-900 mb-4">
        {date.toLocaleDateString('ja-JP', {
          month: 'long',
          day: 'numeric'
        })}ã®å­¦ç¿’å±¥æ­´
      </h3>

      {records.length === 0 ? (
        <div className="text-center py-8 text-gray-500">
          ã“ã®æ—¥ã¯å­¦ç¿’è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“
        </div>
      ) : (
        <div className="space-y-4">
          {records.map(record => (
            <div
              key={record.id}
              className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow cursor-pointer"
              onClick={() => onSessionSelect(record.sessionId)}
            >
              {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
              <div className="flex items-start justify-between mb-2">
                <div className="flex items-center space-x-2">
                  <span className="text-2xl">{getSubjectIcon(record.subject)}</span>
                  <div>
                    <h4 className="font-medium text-gray-900">
                      {record.subject} - {record.topic}
                    </h4>
                    <p className="text-sm text-gray-500">
                      {formatTime(record.completedAt)} ({record.duration}åˆ†)
                    </p>
                  </div>
                </div>

                {/* é›£æ˜“åº¦ãƒãƒƒã‚¸ */}
                <span className={`px-2 py-1 text-xs font-medium rounded ${getDifficultyColor(record.difficulty)}`}>
                  ãƒ¬ãƒ™ãƒ«{record.difficulty}
                </span>
              </div>

              {/* ã‚µãƒãƒªãƒ¼ */}
              <p className="text-sm text-gray-600 mb-3 line-clamp-2">
                {record.summary}
              </p>

              {/* ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ */}
              {record.keyPoints && record.keyPoints.length > 0 && (
                <div className="mb-3">
                  <div className="text-xs text-gray-500 mb-1">å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:</div>
                  <div className="flex flex-wrap gap-1">
                    {record.keyPoints.slice(0, 3).map((point, index) => (
                      <span
                        key={index}
                        className="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded"
                      >
                        {point}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */}
              <div className="flex space-x-2">
                <button className="flex-1 px-3 py-2 text-sm bg-blue-50 text-blue-700 rounded hover:bg-blue-100 transition-colors">
                  ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¦‹ã‚‹
                </button>
                <button className="flex-1 px-3 py-2 text-sm bg-green-50 text-green-700 rounded hover:bg-green-100 transition-colors">
                  å¾©ç¿’ã™ã‚‹
                </button>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  )
}
```

### **3.4 Phase 4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆã¨UXå‘ä¸Š**

#### **3.4.1 ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/components/calendar/ChatHistoryModal.tsx`
```typescript
'use client'

import { useState, useEffect } from 'react'

interface ChatHistoryModalProps {
  sessionId: string
  onClose: () => void
}

interface ChatSession {
  id: string
  title: string
  messages: Array<{
    role: 'user' | 'model'
    parts: Array<{ text: string }>
    timestamp?: string
  }>
  startedAt: string
  completedAt: string
  duration: number
  learningRecord?: {
    subject: string
    topic: string
    summary: string
    keyPoints: string[]
    difficulty: number
  }
}

export function ChatHistoryModal({ sessionId, onClose }: ChatHistoryModalProps) {
  const [session, setSession] = useState<ChatSession | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    fetchSessionDetails()
  }, [sessionId])

  const fetchSessionDetails = async () => {
    try {
      const response = await fetch(
        `${process.env.NEXT_PUBLIC_API_BASE_URL}/chatSessions/${sessionId}`
      )

      if (response.ok) {
        const data = await response.json()
        setSession(data.session)
      } else {
        setError('ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ')
      }
    } catch (error) {
      console.error('Error fetching session:', error)
      setError('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')
    } finally {
      setIsLoading(false)
    }
  }

  const formatTime = (dateStr: string) => {
    return new Date(dateStr).toLocaleTimeString('ja-JP', {
      hour: '2-digit',
      minute: '2-digit'
    })
  }

  const startReview = () => {
    // å¾©ç¿’ãƒ¢ãƒ¼ãƒ‰ã§ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã«é·ç§»
    window.location.href = `/chat?review=${sessionId}`
  }

  if (isLoading) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-8">
          <div className="text-center">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    )
  }

  if (error || !session) {
    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div className="bg-white rounded-lg p-8 max-w-md">
          <div className="text-center">
            <p className="text-red-600 mb-4">{error || 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“'}</p>
            <button
              onClick={onClose}
              className="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
      <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden">
        {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
        <div className="bg-blue-50 p-6 border-b">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-xl font-semibold text-gray-900">
                {session.learningRecord?.subject} - {session.learningRecord?.topic}
              </h2>
              <p className="text-sm text-gray-600">
                {new Date(session.startedAt).toLocaleDateString('ja-JP')}
                {formatTime(session.startedAt)} - {formatTime(session.completedAt)}
                ({session.duration}åˆ†)
              </p>
            </div>
            <button
              onClick={onClose}
              className="text-gray-400 hover:text-gray-600"
            >
              âœ•
            </button>
          </div>

          {/* å­¦ç¿’ã‚µãƒãƒªãƒ¼ */}
          {session.learningRecord && (
            <div className="mt-4 p-4 bg-white rounded border">
              <h3 className="font-medium text-gray-900 mb-2">å­¦ç¿’ã‚µãƒãƒªãƒ¼</h3>
              <p className="text-sm text-gray-700 mb-3">
                {session.learningRecord.summary}
              </p>

              {session.learningRecord.keyPoints && (
                <div>
                  <div className="text-xs text-gray-500 mb-1">é‡è¦ãƒã‚¤ãƒ³ãƒˆ:</div>
                  <div className="flex flex-wrap gap-1">
                    {session.learningRecord.keyPoints.map((point, index) => (
                      <span
                        key={index}
                        className="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded"
                      >
                        {point}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </div>

        {/* ãƒãƒ£ãƒƒãƒˆå±¥æ­´ */}
        <div className="flex-1 overflow-y-auto p-6 max-h-96">
          <h3 className="font-medium text-gray-900 mb-4">å¯¾è©±å±¥æ­´</h3>
          <div className="space-y-4">
            {session.messages.map((message, index) => (
              <div
                key={index}
                className={`flex ${message.role === 'user' ? 'justify-end' : 'justify-start'}`}
              >
                <div
                  className={`max-w-[80%] p-3 rounded-lg ${
                    message.role === 'user'
                      ? 'bg-blue-500 text-white'
                      : 'bg-gray-100 text-gray-900'
                  }`}
                >
                  <div className="text-sm">
                    {message.parts[0]?.text || ''}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
        <div className="bg-gray-50 p-6 border-t">
          <div className="flex space-x-3">
            <button
              onClick={startReview}
              className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
            >
              ã“ã®å†…å®¹ã‚’å¾©ç¿’ã™ã‚‹
            </button>
            <button
              onClick={onClose}
              className="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400 transition-colors"
            >
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}
```
## **4. ğŸš¨ Critical Path: ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **

### **4.1 PWAãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥å®Ÿè£…**

#### **4.1.1 Service Worker**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/public/firebase-messaging-sw.js`
```javascript
importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');

const firebaseConfig = {
  // Firebaseè¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã‹ã‚‰å‹•çš„ã«è¨­å®šï¼‰
};

firebase.initializeApp(firebaseConfig);
const messaging = firebase.messaging();

messaging.onBackgroundMessage((payload) => {
  const notificationTitle = payload.notification.title;
  const notificationOptions = {
    body: payload.notification.body,
    icon: '/icons/icon-192x192.png',
    data: payload.data,
    actions: [
      { action: 'review', title: 'å¾©ç¿’ã™ã‚‹' },
      { action: 'later', title: 'å¾Œã§' }
    ]
  };

  self.registration.showNotification(notificationTitle, notificationOptions);
});
```

#### **4.1.2 ãƒãƒ£ãƒƒãƒˆãƒšãƒ¼ã‚¸ã®ä¿®æ­£**
**ãƒ•ã‚¡ã‚¤ãƒ«**: `web/app/chat/page.tsx`ï¼ˆè¿½åŠ éƒ¨åˆ†ï¼‰
```typescript
// ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†å‡¦ç†ã®è¿½åŠ 
useEffect(() => {
  const handleBeforeUnload = async () => {
    if (currentSessionId && messages.length >= 4) {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº†APIå‘¼ã³å‡ºã—
      await fetch(`${process.env.NEXT_PUBLIC_API_BASE_URL}/chatSessions/${currentSessionId}/complete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
    }
  };

  window.addEventListener('beforeunload', handleBeforeUnload);
  return () => window.removeEventListener('beforeunload', handleBeforeUnload);
}, [currentSessionId, messages.length]);
```

## **5. ğŸ“‹ æ”¹å–„ã•ã‚ŒãŸå®Ÿè£…è¨ˆç”»**

### **5.1 Phaseåˆ¥å®Ÿè£…è¨ˆç”»ï¼ˆ1:Né–¢ä¿‚å¯¾å¿œï¼‰**

| Phase | é …ç›® | è¦‹ç©ã‚‚ã‚Šæ™‚é–“ | å®Ÿè£…é›£æ˜“åº¦ | å„ªå…ˆåº¦ |
|-------|------|------------|------------|--------|
| **Phase 1** | ãƒ‡ãƒ¼ã‚¿æ§‹é€ æ”¹ä¿®ã¨ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç† | 16-20æ™‚é–“ | â­â­â­â­ | Critical |
| **Phase 2** | LearningRecordä¸­å¿ƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ | 12-16æ™‚é–“ | â­â­â­â­â­ | Critical |
| **Phase 3** | ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çµ±åˆUIï¼ˆ1:Nå¯¾å¿œï¼‰ | 20-24æ™‚é–“ | â­â­â­ | High |
| **Phase 4** | æ‰‹å‹•å­¦ç¿’è¨˜éŒ²æ©Ÿèƒ½ | 8-12æ™‚é–“ | â­â­ | Medium |
| **Phase 5** | ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  | 12-16æ™‚é–“ | â­â­â­â­â­ | High |

**ç·è¦‹ç©ã‚‚ã‚Šæ™‚é–“**: 68-88æ™‚é–“ï¼ˆç´„3-4é€±é–“ï¼‰

### **5.2 è©³ç´°å®Ÿè£…è¨ˆç”»ãƒ†ãƒ¼ãƒ–ãƒ«**

| å¯¾å¿œã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€ | å¯¾å¿œã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ« | ä¿®æ­£å†…å®¹ã®æ¦‚è¦ |
|-----------------|-----------------|---------------|
| `functions/src/models` | `types.ts` | **ãƒ‡ãƒ¼ã‚¿æ§‹é€ å®Œå…¨æ”¹ä¿®**: LearningRecord(1) : ChatSession(N)é–¢ä¿‚ã«å¤‰æ›´ã€statusãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  |
| `functions/src/controllers` | `chatController.ts` | **ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ**: AIæ¨å®šâ†’æ—¢å­˜è¨˜éŒ²æ¤œç´¢â†’æ–°è¦/æ—¢å­˜åˆ¤å®šâ†’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| `functions/src/services` | `learningRecordService.ts` | **æ–°è¦ä½œæˆ**: åˆ†é‡æ¨å®šã€è¨˜éŒ²æ¤œç´¢ã€çµ±åˆç®¡ç†ã€AIåˆ†æã€æ‰‹å‹•ä½œæˆæ©Ÿèƒ½ |
| `functions/src/services` | `chatService.ts` | **1:Nå¯¾å¿œæ”¹ä¿®**: ã‚¹ãƒãƒ¼ãƒˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã€çŠ¶æ…‹ç®¡ç†ã€å„ªé›…ãªçµ‚äº†å‡¦ç† |
| `functions/src/services/llm` | `llmService.ts` | **AIåˆ†æå¼·åŒ–**: å­¦ç¿’åˆ†é‡æ¨å®šã€è¤‡æ•°ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ±åˆåˆ†æãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ |
| `functions/src/index.ts` | `index.ts` | **æ–°APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: æ‰‹å‹•è¨˜éŒ²ä½œæˆã€å­¦ç¿’è¨˜éŒ²ä¸€è¦§ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å®Œäº† |
| `web/app/calendar` | `page.tsx` | **1:Nå¯¾å¿œUI**: å­¦ç¿’è¨˜éŒ²ãƒ™ãƒ¼ã‚¹ã®è¡¨ç¤ºã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°è¡¨ç¤ºã€éšå±¤ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ |
| `web/components/calendar` | `LearningRecordCard.tsx` | **æ–°è¦ä½œæˆ**: å­¦ç¿’è¨˜éŒ²ã‚«ãƒ¼ãƒ‰ï¼ˆç´¯è¨ˆæ™‚é–“ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã€é€²æ—è¡¨ç¤ºï¼‰ |
| `web/components/calendar` | `SessionList.tsx` | **æ–°è¦ä½œæˆ**: å­¦ç¿’è¨˜éŒ²å†…ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§è¡¨ç¤º |
| `web/components/calendar` | `ManualRecordForm.tsx` | **æ–°è¦ä½œæˆ**: æ‰‹å‹•å­¦ç¿’è¨˜éŒ²ä½œæˆãƒ•ã‚©ãƒ¼ãƒ  |
| `web/app/chat` | `page.tsx` | **ã‚¹ãƒãƒ¼ãƒˆä½œæˆå¯¾å¿œ**: åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰AIæ¨å®šã€æ—¢å­˜è¨˜éŒ²ã¸ã®ç´ä»˜ã‘è¡¨ç¤º |

### **5.3 ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæˆ¦ç•¥**

#### **5.3.1 æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œ**
```typescript
// Migration script for existing 1:1 relationships to 1:N
export async function migrateTo1NRelationship() {
  // 1. æ—¢å­˜ã®LearningRecordã‚’æ–°ã—ã„æ§‹é€ ã«å¤‰æ›
  // 2. ChatSessionã«learningRecordIdã‚’è¿½åŠ 
  // 3. åŒä¸€subject+topicã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’çµ±åˆ
  // 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã¨ç´¯è¨ˆæ™‚é–“ã‚’å†è¨ˆç®—
}
```

### **5.4 æŠ€è¡“çš„èª²é¡Œè§£æ±º**

#### **Q1 è§£æ±ºç­–: ã‚»ãƒƒã‚·ãƒ§ãƒ³é‡è¤‡é˜²æ­¢**
- **Firestore Transaction**ä½¿ç”¨ã§åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç®¡ç†**ã§æ„å‘³ã®ãªã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’è‡ªå‹•å‰Šé™¤
- **ãƒ–ãƒ©ã‚¦ã‚¶ã‚¯ãƒ­ãƒ¼ã‚ºæ¤œçŸ¥**ã§ãƒ‡ãƒ¼ã‚¿æå¤±é˜²æ­¢

#### **Q2 è§£æ±ºç­–: 1:Né–¢ä¿‚ã®æ¡ç”¨**
- **LearningRecord**: å­¦ç¿’ãƒ†ãƒ¼ãƒã®å¤§ããªæ‹¬ã‚Š
- **ChatSession**: å€‹åˆ¥ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³
- **ãƒ¡ãƒªãƒƒãƒˆ**: ãƒ‡ãƒ¼ã‚¿åŠ¹ç‡æ€§ã€å­¦ç¿’ç¶™ç¶šæ€§ã€åˆ†æåŠ¹ç‡ã®å‘ä¸Š

#### **Q3 è§£æ±ºç­–: LearningRecordä¸­å¿ƒè¨­è¨ˆ**
- **ãƒ‡ãƒ¼ã‚¿åˆ†æ**: LearningRecordãƒ™ãƒ¼ã‚¹ã§é€²æ—è¿½è·¡
- **UIè¡¨ç¤º**: å­¦ç¿’è¨˜éŒ²â†’ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã®éšå±¤æ§‹é€ 
- **ç¶™ç¶šæ€§**: åŒã˜åˆ†é‡ã®å­¦ç¿’ã‚’çµ±åˆç®¡ç†

#### **Q4 è§£æ±ºç­–: æ‰‹å‹•ä½œæˆæ©Ÿèƒ½**
- **isManuallyCreated**ãƒ•ãƒ©ã‚°ã§åŒºåˆ¥
- **å°‚ç”¨API**ã§æ‰‹å‹•è¨˜éŒ²ä½œæˆ
- **å°†æ¥æ‹¡å¼µ**: ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã€ä»–ã‚¢ãƒ—ãƒªé€£æºã¸ã®æº–å‚™

#### **Q5 è§£æ±ºç­–: ç«¶åˆçŠ¶æ…‹ã®åˆ¶å¾¡**
- **Transaction**ã«ã‚ˆã‚‹æ’ä»–åˆ¶å¾¡
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç›£è¦–**ã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼
- **é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**ã§ç•°å¸¸çŠ¶æ…‹å›å¾©

ã“ã®æ”¹å–„ã•ã‚ŒãŸè¨­è¨ˆã«ã‚ˆã‚Šã€ã‚ˆã‚ŠåŠ¹ç‡çš„ã§æ‹¡å¼µæ€§ã®é«˜ã„å­¦ç¿’ç¶™ç¶šã‚µãƒãƒ¼ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒå®Ÿç¾ã§ãã¾ã™ã€‚

## **6. ğŸ¯ æˆåŠŸæŒ‡æ¨™ã¨KPI**

### **6.1 æ©Ÿèƒ½å®Œæˆåº¦æŒ‡æ¨™**
- [ ] å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³è‡ªå‹•ä¿å­˜ç‡: 95%ä»¥ä¸Š
- [ ] ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºæ­£å¸¸å‹•ä½œç‡: 99%ä»¥ä¸Š
- [ ] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥åˆ°é”ç‡: 85%ä»¥ä¸Š
- [ ] ãƒãƒ£ãƒƒãƒˆå±¥æ­´è¡¨ç¤ºã‚¨ãƒ©ãƒ¼ç‡: 1%æœªæº€

### **6.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“æŒ‡æ¨™**
- [ ] ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚é–“: 3ç§’æœªæº€
- [ ] ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º: 1ç§’æœªæº€
- [ ] ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åæ˜ : 5ç§’æœªæº€

### **6.3 å“è³ªç®¡ç†æŒ‡æ¨™**
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸: 80%ä»¥ä¸Š
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸç‡: 95%ä»¥ä¸Š
- [ ] ã‚¯ãƒ­ã‚¹ãƒ–ãƒ©ã‚¦ã‚¶å‹•ä½œç¢ºèª: 3å¤§ãƒ–ãƒ©ã‚¦ã‚¶å¯¾å¿œ

## **7. ğŸ“ ä»Šå¾Œã®æ‹¡å¼µè¨ˆç”»**

### **7.1 çŸ­æœŸæ‹¡å¼µï¼ˆ2-3ãƒ¶æœˆï¼‰**
- å¾©ç¿’å•é¡Œè‡ªå‹•ç”Ÿæˆæ©Ÿèƒ½
- å­¦ç¿’é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€±è¡¨ç¤ºãƒ»æ—¥è¡¨ç¤º

### **7.2 ä¸­æœŸæ‹¡å¼µï¼ˆ6ãƒ¶æœˆï¼‰**
- ä»–ã®ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¢ãƒ—ãƒªã¨ã®é€£æºï¼ˆGoogle Calendarç­‰ï¼‰
- å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®åˆ†æãƒ»ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
- ã‚½ãƒ¼ã‚·ãƒ£ãƒ«æ©Ÿèƒ½ï¼ˆå­¦ç¿’ä»²é–“ã¨ã®å…±æœ‰ï¼‰

### **7.3 é•·æœŸæ‹¡å¼µï¼ˆ1å¹´ï¼‰**
- AIå­¦ç¿’ã‚³ãƒ¼ãƒãƒ³ã‚°æ©Ÿèƒ½
- é©å¿œçš„å­¦ç¿’ãƒ‘ã‚¹ææ¡ˆ
- ãƒãƒ«ãƒãƒ‡ãƒã‚¤ã‚¹åŒæœŸ

ã“ã®PRD v1.2ã«ã‚ˆã‚Šã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€£æºãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…ãŒç¾å®Ÿçš„ã‹ã¤æ®µéšçš„ã«é€²ã‚ã‚‰ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¨ã£ã¦ä¾¡å€¤ã®ã‚ã‚‹å­¦ç¿’ç¶™ç¶šã‚µãƒãƒ¼ãƒˆæ©Ÿèƒ½ã‚’æä¾›ã§ãã¾ã™ã€‚
