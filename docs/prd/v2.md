# **学習発見・興味拡張機能 MVP開発仕様書 (v2)**

## **1. はじめに**

### **1.1 本ドキュメントの目的**
本ドキュメントは、「学習発見・興味拡張機能」のMVP（Minimum Viable Product）開発に必要な全ての技術情報を定義するものです。フェーズ1の課題である「そもそも知らない」とフェーズ2の課題である「飽きる・知ろうともしない」を解決するための製品要求仕様（PRD）を継承しつつ、最小限の機能で最大の効果を狙う実装方針を採用します。

### **1.2 v2 MVPのスコープ**
*   **目的:** ユーザーが新しい分野への興味を持ち、自主的に学習を始めるきっかけを最小限の機能で提供する。
*   **対象機能:**
    *   豆知識表示システム（ログイン時に短い豆知識を表示）
    *   異分野横断クイズ（専門分野と他分野の意外な繋がり発見）
    *   興味領域マップ（ユーザーの興味の可視化、簡易版）
    *   チャット画面の既存メッセージを豆知識形式に変更
*   **対象外（v3以降で実装）:** 学習ストリーク機能、ログインボーナス、高度なAI推薦、ソーシャル機能、画像表示機能。

### **1.3 期待される効果**
*   **フェーズ1解決:** 「そもそも知らない」→ ログイン時の豆知識で新しい分野への扉を開く
*   **フェーズ2解決:** 「飽きる・知ろうともしない」→ 既存興味と新分野の繋がりを発見し、自然な興味拡張を促進
*   **学習意欲の喚起:** 予想外の知識の繋がりによる「もっと知りたい」気持ちの醸成
*   **チャット体験の向上:** 従来の「知識の探求を始めましょう」メッセージを豆知識で置き換え、より魅力的な学習開始体験を提供

### **1.4 運用前提（今回のPRDに反映）**
- Q1（ユーザ規模）: 短期的な想定は **1,000ユーザー** を最悪ケースとして設計します。将来的な拡張は考慮するが、v2では大規模最適化は行わない方針です。
- Q2（将来変更性）: 実装はモジュラー化（API層・サービス層・データ層を分離）しておき、将来の機能追加やアルゴリズム差し替えを容易にします。
- Q3（Embeddings/ベクトルDB）: v2では埋め込みや外部ベクトルDBの導入は行いません。将来バージョンで検討します。

## **2. 技術スタックとツール**

| 領域 | 技術・ツール | バージョン（推奨） |
| :--- | :--- | :--- |
| **フロントエンド** | Next.js, React, TypeScript | Next.js 14+, React 18+ |
| **バックエンド** | Node.js, TypeScript, Express | Node.js 20+ |
| **インフラ** | Vercel, Firebase (Authentication, Firestore, Functions) | - |
| **言語** | TypeScript | 5.x |
| **パッケージ管理** | npm | 10.x |
| **UIライブラリ** | Tailwind CSS + Shadcn/ui | - |
| **状態管理** | Zustand | 4.x |
| **LLM API** | Google Gemini API (or OpenAI API) | 知識生成・関連性分析用 |

## **3. 機能仕様**

### **3.1 豆知識表示システム（MVP版）**

#### **機能概要**
- ログイン時に10-30文字程度の短い豆知識を表示
- ユーザーの学習履歴から関連する分野の知識を選択
- チャット画面の「知識の探求を始めましょう」メッセージを豆知識に置き換え

#### **期待される効果**
- 新しい分野への最初の接触点を提供
- ログイン時の学習意欲向上
- 予想外の知識との出会いによる興味の種まき
- より魅力的な学習開始体験

#### **実装詳細**
- 知識カテゴリ：数学、理科、歴史、言語、技術等の基本分野
- 1つの豆知識は10-30文字の短文（読みやすく印象に残る分量）
- 「もっと詳しく」ボタンでGoogle検索へのリンクを提供
- LLMが図解に適した内容はMermaid記法での簡単な図を生成（オプション）
- ユーザーの既存学習記録（subject/topic）から関連する知識を選択

#### **表示パターン例**
- 「ピタゴラスの定理は古代バビロニアでも知られていた」
- 「蝶の羽の色は実は透明で、構造で色が見える」
- 「プログラミングのバグの語源は実際の虫だった」

### **3.2 異分野横断クイズ（簡易版）**

#### **機能概要**
- ユーザーの既存の学習分野と他分野の繋がりを簡単なクイズで紹介
- LLMベースで関連性を分析し、3択問題を生成
- 「数学×音楽」「料理×化学」など、シンプルな組み合わせに特化

#### **期待される効果**
- 既存知識を活用した新分野への導入
- 「こんな繋がりがあるんだ」という発見の喜び
- 知識の横断的理解のきっかけ提供

#### **実装詳細**
- 週1-2回程度の頻度で新しいクイズを提供
- 正解時には簡潔な解説とGoogle検索リンク
- 難易度は固定（中級程度）でシンプルに運用
- 関連性分析はLLMに任せ、複雑なアルゴリズムは避ける

### **3.3 興味領域マップ（簡易版）**

#### **機能概要**
- ユーザーの学習履歴（LearningRecordのsubject/topic）を基に簡易的な興味マップを表示
- データ不足時はサンプルマップと提案を表示
- 基本的な可視化に特化し、複雑なインタラクションは避ける

#### **期待される効果**
- 自分の学習分野の全体像把握
- 未開拓領域の認識
- 学習の方向性への気づき

#### **実装詳細**
- シンプルなノード・エッジ表示（D3.jsまたはChart.js使用）
- 学習データが十分でない場合はプレースホルダーを表示
- 各ノードクリックでその分野の豆知識やクイズへの導線
- 新領域提案はLLMベースで簡単に実装

## **4. データベース設計（MVP版）**

### **4.1 コレクション構造**

#### **knowledge_items** (豆知識データ - 簡素化)
```typescript
{
  id: string;
  category: string; // 'math', 'science', 'history', etc.
  content: string; // 10-30文字のメイン内容
  googleSearchQuery?: string; // 「もっと詳しく」用の検索キーワード
  difficulty: 'beginner' | 'intermediate' | 'advanced';
  tags: string[]; // 関連分野タグ
  relatedTopics: string[]; // LearningRecordのsubject/topicとマッチング用
  mermaidDiagram?: string; // オプション：図解が有効な場合のMermaid記法
  createdAt: Timestamp;
  views: number; // 表示回数
}
```

#### **quiz_items** (クイズデータ - 簡素化)
```typescript
{
  id: string;
  primaryCategory: string; // ユーザーの既知分野
  secondaryCategory: string; // 新しい分野
  question: string;
  options: string[]; // 3択
  correctAnswer: number;
  explanation: string; // 簡潔な解説
  googleSearchQuery?: string; // 詳細情報用の検索キーワード
  createdAt: Timestamp;
}
```

#### **user_discovery** (ユーザー発見履歴 - 簡素化)
```typescript
{
  userId: string;
  knowledgeHistory: {
    itemId: string;
    viewedAt: Timestamp;
    liked: boolean;
    detailViewed: boolean; // Google検索を開いたか
  }[];
  quizHistory: {
    itemId: string;
    answeredAt: Timestamp;
    isCorrect: boolean;
    selectedOption: number;
  }[];
  interestMap: {
    [category: string]: {
      level: number; // 0-100の興味レベル
      lastEngagement: Timestamp;
      itemsViewed: number;
    };
  };
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

## **5. API設計（MVP版）**

### **5.1 豆知識API**

#### **GET /api/discovery/login-knowledge**
- **概要**: ログイン時に表示する豆知識を取得
- **パラメータ**: userId（認証情報から取得）
- **レスポンス**:
  ```typescript
  {
    knowledge: {
      id: string;
      content: string; // 10-30文字
      category: string;
      googleSearchQuery?: string;
      mermaidDiagram?: string;
    };
    connectionToUserInterests?: string; // ユーザーの既知分野との繋がり説明
  }
  ```

#### **POST /api/discovery/knowledge/interact**
- **概要**: 豆知識への反応を記録
- **パラメータ**:
  ```typescript
  {
    knowledgeId: string;
    action: 'like' | 'view_detail';
  }
  ```

### **5.2 クイズAPI**

#### **GET /api/discovery/quiz/weekly**
- **概要**: 週次クイズを取得
- **パラメータ**: userId（認証情報から取得）
- **レスポンス**:
  ```typescript
  {
    quiz: {
      id: string;
      question: string;
      options: string[];
      primaryCategory: string;
      secondaryCategory: string;
    };
    contextExplanation: string; // なぜこのクイズが選ばれたか
  }
  ```

#### **POST /api/discovery/quiz/answer**
- **概要**: クイズの回答を記録
- **パラメータ**:
  ```typescript
  {
    quizId: string;
    selectedOption: number;
  }
  ```
- **レスポンス**:
  ```typescript
  {
    isCorrect: boolean;
    correctAnswer: number;
    explanation: string;
    googleSearchQuery?: string;
  }
  ```

### **5.3 興味マップAPI**

#### **GET /api/discovery/interest-map**
- **概要**: ユーザーの興味領域マップデータ取得
- **レスポンス**:
  ```typescript
  {
    hasData: boolean; // 十分なデータがあるか
    nodes: {
      id: string;
      category: string;
      level: number;
      itemsViewed: number;
    }[];
    edges: {
      source: string;
      target: string;
      strength: number;
    }[];
    suggestions?: {
      category: string;
      reason: string;
    }[];
    placeholderMessage?: string; // データ不足時のメッセージ
  }
  ```## **6. UI/UX設計（MVP版）**

### **6.1 既存チャット画面の改修**

#### **チャット初期メッセージの豆知識化** (`/web/app/chat/page.tsx`)
- **現在**: 「知識の探求を始めましょう」などの固定メッセージ
- **変更後**: ログイン時豆知識システムと連携
- **表示内容**:
  - 10-30文字の豆知識テキスト
  - 「もっと詳しく調べる」ボタン（Google検索リンク）
  - オプション：Mermaid図解がある場合は簡易表示
- **UX配慮**: fe-design.mdの「知識のsanctuary」テーマに合致する落ち着いた表示

### **6.2 新規画面（最小限）**

#### **発見ホーム画面** (`/web/app/discovery/page.tsx`)
- **ヘッダー**: ロゴ、ナビゲーション
- **メインコンテンツ**:
  - 本日の豆知識表示エリア
  - 週次クイズセクション（シンプルな3択UI）
  - 興味マップへのリンク
- **フッター**: 基本ナビゲーション

#### **クイズ画面** (`/web/app/discovery/quiz/page.tsx`)
- **シンプルな3択UI**:
  - 問題文
  - 3つの選択肢ボタン
  - 結果表示（正解/不正解 + 簡潔な解説）
  - Google検索リンク

#### **興味マップ画面** (`/web/app/discovery/map/page.tsx`)
- **基本的な可視化**:
  - 学習データがある場合：シンプルなノード・エッジ表示
  - データ不足時：プレースホルダー + 「学習を続けてマップを充実させましょう」メッセージ

### **6.3 コンポーネント設計（最小限）**

#### **発見系コンポーネント** (`/web/components/discovery/`)

**KnowledgeDisplay.tsx** - 豆知識表示（チャット画面用）
- **Props**: knowledge, onDetailView
- **機能**: 豆知識テキスト表示、Google検索リンク、Mermaid図解（オプション）

**SimpleQuiz.tsx** - 簡易クイズUI
- **Props**: quiz, onAnswer
- **機能**: 3択選択、結果表示、解説表示

**BasicInterestMap.tsx** - 基本興味マップ
- **Props**: mapData, hasData
- **機能**: ノード表示またはプレースホルダー表示

**GoogleSearchButton.tsx** - Google検索ボタン
- **Props**: searchQuery, label
- **機能**: Google検索を新しいタブで開く

## **7. 実装計画**

| 対応するフォルダ | 対応するファイル | 修正内容の概要 |
|-----------------|-----------------|---------------|
| web/app/discovery/ | page.tsx | 発見ホーム画面の新規作成（豆知識ガチャ、ストリーク表示、クイズ挑戦ボタン） |
| web/app/discovery/knowledge/[id]/ | page.tsx | 豆知識詳細画面の新規作成（詳細表示、関連トピック、保存機能） |
| web/app/discovery/quiz/ | page.tsx | クイズ画面の新規作成（インタラクティブUI、制限時間、結果表示） |
| web/app/discovery/map/ | page.tsx | 興味マップ画面の新規作成（インタラクティブマインドマップ） |
| web/components/discovery/ | KnowledgeCard.tsx | 豆知識表示カードコンポーネントの新規作成（ガチャ演出対応） |
| web/components/discovery/ | QuizComponent.tsx | クイズUIコンポーネントの新規作成（選択肢、フィードバック） |
| web/components/discovery/ | StreakIndicator.tsx | ストリーク表示コンポーネントの新規作成（連続日数、達成バッジ） |
| web/components/discovery/ | InterestMap.tsx | 興味マップコンポーネントの新規作成（D3.js使用予定） |
| web/components/discovery/ | GachaAnimation.tsx | ガチャ演出アニメーションコンポーネントの新規作成（Framer Motion使用） |
| web/components/discovery/ | DailyBonus.tsx | ログインボーナス表示コンポーネントの新規作成 |
| web/store/ | discoveryStore.ts | 発見機能用状態管理ストアの新規作成（Zustand使用） |
| functions/src/controllers/ | discoveryController.ts | 発見機能APIコントローラの新規作成 |
| functions/src/services/ | discoveryService.ts | 発見機能ビジネスロジックサービスの新規作成 |
| functions/src/services/ | knowledgeGenerator.ts | AI知識生成サービスの新規作成（Gemini API使用） |
| functions/src/services/ | quizGenerator.ts | AIクイズ生成サービスの新規作成（横断的な関連性分析） |
| web/components/common/ | Navigation.tsx | 発見機能へのナビゲーションメニュー項目追加 |
| web/app/ | layout.tsx | 発見機能用のメタデータとレイアウト更新 |
| web/types/ | discovery.ts | 発見機能用の型定義ファイル新規作成 |

## **8. 開発フェーズ**

### **フェーズ1: 基盤構築 (3週間)**
**目標**: v2機能の土台となるデータ構造とAPI基盤の構築

**Week 1: データベース・API設計**
- [ ] Firestoreコレクション設計と初期セットアップ
- [ ] API エンドポイントの基本構造実装
- [ ] 型定義ファイル作成 (`web/types/discovery.ts`)
- [ ] 基本的なサービスクラス実装 (`discoveryService.ts`)

**Week 2: 状態管理・ルーティング**
- [ ] Zustand ストア設計・実装 (`discoveryStore.ts`)
- [ ] Next.js ルーティング設定
- [ ] 認証との統合
- [ ] 基本的なページレイアウト作成

**Week 3: AI統合・データ生成**
- [ ] Gemini API統合 (`knowledgeGenerator.ts`, `quizGenerator.ts`)
- [ ] 初期知識データとクイズデータの生成
- [ ] カテゴリ関連性データの構築
- [ ] 基本的なユーザー分析機能実装

### **フェーズ2: 豆知識ガチャ機能 (2.5週間)**
**目標**: 毎日の豆知識ガチャシステムの完全実装

**Week 4-5: コア機能実装**
- [ ] 豆知識表示・取得API実装
- [ ] ガチャ演出アニメーション (`GachaAnimation.tsx`)
- [ ] 豆知識カード UI (`KnowledgeCard.tsx`)
- [ ] ユーザー閲覧履歴追跡機能

**Week 6 (前半): パーソナライズ機能**
- [ ] ユーザー興味分析アルゴリズム
- [ ] 個人化された豆知識選択ロジック
- [ ] 「もっと詳しく」機能実装
- [ ] 詳細画面の実装

### **フェーズ3: 異分野横断クイズ機能 (3週間)**
**目標**: AIによる動的クイズ生成と分野横断問題システム

**Week 7: クイズ生成システム**
- [ ] AIクイズ生成アルゴリズム実装
- [ ] 分野間関連性分析機能
- [ ] ユーザーレベル適応システム
- [ ] クイズデータベース管理機能

**Week 8: クイズUI・UX**
- [ ] クイズコンポーネント実装 (`QuizComponent.tsx`)
- [ ] 制限時間・進捗管理
- [ ] フィードバック・解説表示
- [ ] 結果画面とフロー管理

**Week 9: 学習追跡・改善**
- [ ] クイズ履歴・分析機能
- [ ] 間違い問題の再出題システム
- [ ] 難易度自動調整アルゴリズム
- [ ] 統計・成長可視化

## **7. 技術実装（MVP版）**

### **7.1 フロントエンド実装**

#### **状態管理（Zustand）** - `/web/store/discoveryStore.ts`
```typescript
interface DiscoveryState {
  // 豆知識関連
  todayKnowledge: KnowledgeItem | null;
  // クイズ関連
  currentQuiz: QuizItem | null;
  quizResults: QuizResult[];
  // 興味マップ関連（基本データのみ）
  interestMapData: MapData | null;
  // アクション
  loadTodayKnowledge: () => Promise<void>;
  completeQuiz: (result: QuizResult) => Promise<void>;
  loadInterestMap: () => Promise<void>;
}
```

#### **APIクライアント** - `/web/lib/apiClient.ts`
```typescript
// 豆知識取得（ログイン時1回）
export const getTodayKnowledge = async (): Promise<KnowledgeItem>;
// 週次クイズ取得
export const getWeeklyQuiz = async (): Promise<QuizItem>;
// クイズ結果送信
export const submitQuizResult = async (result: QuizResult): Promise<void>;
// 興味マップデータ取得
export const getInterestMap = async (): Promise<MapData>;
```

### **7.2 バックエンド実装（Firebase Functions）**

#### **新規エンドポイント** - `/functions/src/controllers/discoveryController.ts`

**GET /api/discovery/knowledge** - 本日の豆知識取得
- **処理**: ユーザーの学習履歴から興味分野分析
- **返却**: KnowledgeItem（10-30文字 + Google検索キーワード）
- **キャッシュ**: ユーザー別・日別

**GET /api/discovery/quiz** - 週次クイズ取得
- **処理**: ユーザーの学習分野から関連3択問題生成
- **返却**: QuizItem（問題 + 3選択肢 + 解説）

**POST /api/discovery/quiz/result** - クイズ結果記録
- **処理**: 正解率をLearningRecordに記録
- **分析**: 将来の豆知識・クイズ生成に活用

**GET /api/discovery/map** - 興味マップデータ取得
- **処理**: 学習履歴をノード・エッジ形式に変換
- **返却**: 基本的なマップデータまたはプレースホルダー

#### **サービス層** - `/functions/src/services/discoveryService.ts`

**generateKnowledgeFromHistory()** - 豆知識生成
- **入力**: ユーザーの学習履歴（LearningRecord）
- **処理**:
  1. 主要学習分野の特定（subjects/topics）
  2. Gemini APIで関連豆知識生成（10-30文字制限）
  3. Google検索用キーワード抽出
- **出力**: KnowledgeItem

**generateQuizFromInterests()** - クイズ生成
- **入力**: ユーザーの興味分野
- **処理**:
  1. 学習分野の横断的要素抽出
  2. 3択問題生成（基礎レベル）
  3. 簡潔な解説文生成
- **出力**: QuizItem

**buildBasicInterestMap()** - 興味マップ構築
- **入力**: LearningRecord データ
- **処理**:
  1. 学習分野のカテゴリ化
  2. 基本的なノード・エッジ関係構築
  3. データ不足時はプレースホルダー返却
- **出力**: MapData

### **7.3 データベース変更（最小限）**

#### **既存コレクション活用**
- **users**: 既存のままで設定追加なし
- **learningRecords**: 既存構造を豆知識・クイズ分析に活用
- **chatSessions**: 既存のままで変更なし

#### **新規コレクション（最小限）**

**dailyKnowledge** - 豆知識キャッシュ
```typescript
{
  id: string;
  userId: string;
  date: string; // YYYY-MM-DD
  knowledgeId: string; // `knowledge_items` への参照（軽量化）
  assignedAt: Timestamp;
}
```

**quizResults** - クイズ結果記録
```typescript
{
  id: string;
  userId: string;
  quizType: 'weekly';
  question: string;
  userAnswer: string;
  isCorrect: boolean;
  submittedAt: Timestamp;
}
```

### **7.4 LLM統合（簡素化）**

#### **Gemini API活用** - `/functions/src/services/llm/discoveryLLM.ts`

**豆知識生成プロンプト**:
```
ユーザーの学習分野: [subjects/topics from LearningRecord]
以下の条件で豆知識を1つ生成してください：
1. 10-30文字以内
2. 学習分野に関連する興味深い事実
3. Google検索用キーワード1つ
4. 専門用語は避け、分かりやすく
```

#### **運用方針（v2: MVP向け）**
- 生成は可能な限り**事前バッチ生成**（毎日/毎週）して `knowledge_items` または `dailyKnowledge`（参照方式）にキャッシュする。リアルタイムで個別LLM呼び出しを行うのは最小限に留める。
- v2では**埋め込み（embeddings）や外部ベクトルDBは導入しない**。将来の v3 で検討する。
- キャッシュヒット時は LLM 呼び出しを行わず即時レスポンスを返す実装とする。

**クイズ生成プロンプト**:
```
ユーザーの学習分野: [subjects/topics]
基礎レベルの3択問題を生成してください：
1. 分野横断的な内容
2. 選択肢は明確に区別可能
3. 解説は50文字以内
```

### **7.5 開発工程（MVP版）**

#### **Phase 1: 基盤構築（1週間）**
- discoveryStore.ts実装
- discoveryController.ts基本エンドポイント
- 豆知識生成ロジック

#### **Phase 2: UI実装（1週間）**
- KnowledgeDisplay.tsx（チャット統合）
- SimpleQuiz.tsx
- BasicInterestMap.tsx

#### **Phase 3: 統合・テスト（0.5週間）**
- エンドポイント統合
- 基本動作確認
- バグ修正

**総開発期間**: 2.5週間（MVP版）

## **8. 実装計画詳細（MVP版）**

### **8.1 開発スケジュール**

#### **Week 1: 基盤・API実装**
- [ ] `discoveryController.ts` 基本エンドポイント実装
- [ ] `discoveryService.ts` 豆知識・クイズ生成ロジック
- [ ] `dailyKnowledge`, `quizResults` コレクション設計
- [ ] Gemini API統合（基本プロンプト）
- [ ] `discoveryStore.ts` 状態管理実装

#### **Week 2: UI・フロントエンド実装**
- [ ] `KnowledgeDisplay.tsx` チャット画面統合
- [ ] `SimpleQuiz.tsx` 基本クイズUI
- [ ] `BasicInterestMap.tsx` プレースホルダー表示
- [ ] `/discovery` 基本ページ構築
- [ ] ナビゲーション追加

#### **Week 2.5: 統合・テスト・デプロイ**
- [ ] エンドツーエンドテスト
- [ ] 基本機能確認
- [ ] バグ修正
- [ ] プロダクション環境デプロイ

### **8.2 技術的制約・考慮事項**

#### **簡素化による制約**
- Gemini API呼び出し回数制限（ユーザー毎・日別）
- 豆知識の質は初期段階では基本レベル
- 興味マップは学習データ蓄積後に機能性向上
- 画像・高度なアニメーションは今後のバージョンで対応

#### **MVP後の拡張ポイント**
- 豆知識の文字数増加（200-300文字へ）
- ストリーク・ゲーミフィケーション機能
- 高度な興味マップ可視化
- AI画像生成統合
- ソーシャル機能（共有・コメント）

### **8.3 成功指標（MVP版）**

#### **技術指標**
- API応答時間: <2秒
- エラー率: <5%
- ページロード時間: <3秒

#### **ユーザー体験指標**
- 豆知識表示率: 90%以上（ログイン時）
- クイズ完了率: 60%以上
- Google検索リンククリック率: 30%以上

#### **ビジネス指標**
- ユーザーログイン頻度: 週3回以上
- 発見機能利用率: 40%以上
- ユーザー継続率: 1ヶ月後80%以上

**Week 12 (前半): 目標・統計機能**
- [ ] 週間・月間目標設定機能
- [ ] 学習統計ダッシュボード
- [ ] 進捗チャート (`ProgressChart.tsx`)
- [ ] 達成通知・お祝い機能

### **フェーズ5: 興味マップ・可視化機能 (3週間)**
**目標**: インタラクティブな興味領域マップの実装

**Week 13: マップ基盤**
- [ ] D3.js統合とSVG描画システム
- [ ] ノード・エッジデータ構造設計
- [ ] 基本的なフォースシミュレーション
- [ ] レスポンシブ対応

**Week 14: インタラクション**
- [ ] ドラッグ・ズーム・パン操作
- [ ] ノード選択・詳細表示
- [ ] アニメーション・トランジション
- [ ] 興味マップコンポーネント (`InterestMap.tsx`)

**Week 15: AI提案・最適化**
- [ ] 新領域提案アルゴリズム
- [ ] マップレイアウト最適化
- [ ] パフォーマンス改善
- [ ] モバイル対応調整

### **フェーズ6: 統合・最適化・テスト (2週間)**
**目標**: 全機能の統合とユーザビリティ向上

**Week 16: 統合・調整**
- [ ] 全機能の統合テスト
- [ ] ユーザーフロー最適化
- [ ] パフォーマンス改善
- [ ] バグ修正・安定性向上

**Week 17: 最終調整・リリース準備**
- [ ] ユーザビリティテスト
- [ ] アクセシビリティ対応
- [ ] エラーハンドリング強化
- [ ] デプロイ・監視システム設定

### **総開発期間: 17週間（約4ヶ月）**

## **9. 技術的課題と解決策**

### **Q1: AI による知識・クイズ生成の品質をどう保証するか？**
**課題**: AIが生成する豆知識やクイズの正確性、教育的価値の確保
**解決策**:
- 専門分野ごとの事実確認データベース構築
- 生成内容の段階的チェックシステム
- ユーザーフィードバックによる品質改善ループ
- 初期段階では人手による内容確認プロセス導入

### **Q2: ユーザーの興味分析アルゴリズムの精度をどう向上させるか？**
**課題**: 限られたユーザー行動データから正確な興味領域を推定
**解決策**:
- 明示的フィードバック（いいね、保存）と暗示的フィードバック（閲覧時間、再訪）の組み合わせ
- 冷静スタート問題への対応（初期アンケート、デモグラフィック情報活用）
- 機械学習モデルの段階的改善（協調フィルタリング→コンテンツベース→ハイブリッド）

### **Q3: D3.js を使った興味マップのパフォーマンス最適化をどう実現するか？**
**課題**: 大量のノード・エッジを持つマップの描画パフォーマンス
**解決策**:
- 仮想化による表示ノード数の制限
- WebGL レンダリングの検討
- LOD（Level of Detail）システムの導入
- モバイル向けの軽量版マップ提供

### **Q4: 継続的な学習モチベーション維持のための心理学的アプローチは？**
**課題**: 長期的な学習習慣の形成と維持
**解決策**:
- 自己決定理論に基づく内発的動機の促進
- 小さな成功体験の積み重ね設計
- ソーシャル要素は避け、個人の成長にフォーカス
- 適度な難易度調整（フロー理論の活用）

## **10. リスク管理**

### **技術リスク**
- **LLM API のコスト増大**: 使用量監視とキャッシュ戦略で対応
- **D3.js の学習コスト**: プロトタイプでの事前検証、ライブラリ代替案準備
- **モバイル対応の複雑さ**: レスポンシブ設計とPWA最適化に重点

### **ユーザビリティリスク**
- **機能の複雑さによる離脱**: 段階的機能開放とオンボーディング強化
- **AI生成コンテンツへの不信**: 透明性の確保と品質指標の可視化
- **学習効果の実感不足**: 成長可視化とフィードバック機能の充実

### **ビジネスリスク**
- **ユーザー獲得の困難**: 既存v0、v1ユーザーからの自然な移行促進
- **継続率の低下**: A/Bテストによる機能最適化と改善サイクル確立

## **11. TODOリスト**

### **フェーズ1: 基盤構築**
#### **ビジネス指標**
- ユーザーログイン頻度: 週3回以上
- 発見機能利用率: 40%以上
- ユーザー継続率: 1ヶ月後80%以上

---

## **MVP実装計画表**

| **フェーズ** | **対応フォルダ** | **対応ファイル** | **修正内容の概要** |
|-------------|----------------|-----------------|------------------|
| **基盤構築** | `/functions/src/controllers/` | `discoveryController.ts` | 豆知識・クイズ・マップデータ取得API実装 |
| | `/functions/src/services/` | `discoveryService.ts` | LearningRecord分析・豆知識生成ロジック |
| | `/functions/src/services/llm/` | `discoveryLLM.ts` | Gemini API統合（簡素化プロンプト） |
| | `/web/store/` | `discoveryStore.ts` | 発見機能用Zustand状態管理 |
| **UI実装** | `/web/components/discovery/` | `KnowledgeDisplay.tsx` | チャット画面豆知識表示コンポーネント |
| | | `SimpleQuiz.tsx` | 基本3択クイズUIコンポーネント |
| | | `BasicInterestMap.tsx` | 興味マップ基本表示・プレースホルダー |
| | | `GoogleSearchButton.tsx` | Google検索リンクボタン |
| | `/web/app/chat/` | `page.tsx` | チャット初期メッセージ豆知識統合 |
| | `/web/app/discovery/` | `page.tsx` | 発見ホーム画面（最小限） |
| | `/web/app/discovery/quiz/` | `page.tsx` | シンプルクイズ画面 |
| | `/web/app/discovery/map/` | `page.tsx` | 興味マップ画面（基本版） |
| | `/web/components/common/` | `Navigation.tsx` | 発見メニュー項目追加 |
| **データベース** | Firestore | `dailyKnowledge` コレクション | 豆知識キャッシュ用新規コレクション |
| | | `quizResults` コレクション | クイズ結果記録用新規コレクション |
| **統合** | `/web/lib/` | `apiClient.ts` | 発見機能APIクライアント関数追加 |

---

**プロダクト要求仕様書 v2.0（MVP版）**
**最終更新**: 2024年12月
**対象バージョン**: MVP 学習発見・興味拡張機能
**開発期間**: 2.5週間
**リリース予定**: 2025年Q1

---

## **設計書確認チェックリスト**
- [x] 実装詳細やコードスニペットは含まれていない
- [x] 要件が正確に抽出されている
- [x] 要件が簡潔に文書化されている
- [x] 必要な情報がすべて含まれている
- [x] 必要な詳細が省略されていない
- [x] 日本語の設計書が明確で理解しやすく、箇条書きや表を効果的に使用している
- [x] 実装計画表（対応するフォルダ、対応するファイル、修正内容の概要の列）が含まれている
- [x] MVP版として簡素化された機能が明確に定義されている

**MVP設計書が完成しました。**

**Q1**: このMVP版設計は、ユーザーフィードバックで指摘された「複雑すぎる」「文字数が多すぎる」「ゲーミフィケーションが重い」という課題を適切に解決していますか？

**Q2**: 2.5週間という開発期間でこのMVP機能セットは実装可能でしょうか？

**Q3**: 既存のLearningRecordシステムとの統合方式に技術的な課題はありませんか？
