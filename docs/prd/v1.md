# **学習継続サポート機能 開発仕様書 (v1)**

## **1. はじめに**

### **1.1 本ドキュメントの目的**
本ドキュメントは、「学習継続サポート機能」の開発に必要な全ての技術情報を定義するものです。フェーズ4の課題である「継続性がない」「管理アプリの手間がある」を解決するための製品要求仕様（PRD）を継承しつつ、具体的な環境構築、プロジェクト構成、コーディング規約、デプロイ手順までを網羅し、開発チームがスムーズに開発に着手できることを目的とします。

### **1.2 MVPのスコープ**
*   **目的:** ユーザーが学習を継続的に行えるよう、自動記録とリマインドでサポートする。
*   **対象機能:**
    *   AI対話の自動学習記録生成とカレンダー登録（独自カレンダー）
    *   エビングハウスの忘却曲線に基づくリマインド通知（PWAプッシュ）
    *   独自カレンダー画面
    *   通知からの問題解決機能（PWA簡易UIまたは問題表示）
*   **対象外:** 高度なパーソナライズ、複数デバイス同期。

### **1.3 TODOリスト**
- [ ] 学習記録自動生成機能の実装
- [ ] 独自カレンダー画面の実装
- [ ] リマインド通知システムの構築（PWAプッシュ）
- [ ] 通知内問題解決機能の開発
- [ ] UI/UXの設計と実装
- [ ] テストケースの作成
- [ ] デプロイとリリース

## **2. 技術スタックとツール**

| 領域 | 技術・ツール | バージョン（推奨） |
| :--- | :--- | :--- |
| **フロントエンド** | Next.js, React, TypeScript | Next.js 14+, React 18+ |
| **バックエンド** | Node.js, TypeScript, Express | Node.js 20+ |
| **インフラ** | Vercel, Firebase (Authentication, Firestore, Functions, Cloud Messaging) | - |
| **言語** | TypeScript | 5.x |
| **パッケージ管理** | npm | 10.x |
| **UIライブラリ** | Shadcn/ui (推奨) | - |
| **状態管理** | Zustand (推奨) | 4.x |
| **LLM API** | Google Gemini API (or OpenAI API) | - |
| **通知** | Firebase Cloud Messaging + PWA Push API | スマホ向けPWAプッシュ通知 |
| **カレンダー** | 独自カレンダー | 学習記録の表示専用（拡張性考慮） |

## **3. 環境構築ガイド**

### **3.1 前提条件**
*   [Node.js](https://nodejs.org/) (v20以上) と npm がインストールされていること。
*   [Git](https://git-scm.com/) がインストールされていること。
*   GoogleアカウントとFirebaseプロジェクトを作成済みであること。
*   GitHubアカウントとVercelアカウントを作成済みであること。

### **3.2 Firebase プロジェクトのセットアップ**
1.  **Firebase CLIのインストールとログイン**
  ```bash
  npm install -g firebase-tools
  firebase login
  ```
2.  **プロジェクトの初期化**
  *   ローカルにプロジェクトディレクトリを作成し、その中で以下のコマンドを実行します。
  ```bash
  # 対話形式で設定を進める
  firebase init

  # 選択する機能:
  # ◯ Firestore: Firestore security rules and indexes files
  # ◯ Functions: Configure a new functions directory and related files
  # ◯ Hosting: Configure files for Firebase Hosting and (optionally) set up GitHub Action deploys (※Vercelを使うが念のため)
  # ◯ Emulators: Configure local emulators for Firebase features
  ```
3.  **Firebaseコンソールでの設定**
  *   **Authentication:** 「Sign-in method」タブで「メール/パスワード」を有効にします。
  *   **Firestore:** 「データベースの作成」からテストモードまたは本番環境モードでデータベースを初期化します。
  *   **Cloud Messaging:** 通知機能のために有効化します。

### **3.3 Google Calendar APIの設定**
1.  [Google Cloud Console](https://console.cloud.google.com/) にアクセスします。
2.  Calendar APIを有効化します。
3.  OAuth 2.0 クライアントIDを作成します。
4.  作成したクライアントIDとシークレットを安全な場所に保管します。

### **3.4 LLM APIキーの取得**
*   **Gemini API の場合:**
  1.  [Google AI Studio](https://aistudio.google.com/) にアクセスします。
  2.  「Get API key」をクリックし、新しいAPIキーを作成します。
  3.  作成したAPIキーを安全な場所に保管します。
*   **OpenAI API の場合:**
  1.  [OpenAI Platform](https://platform.openai.com/) にアクセスし、ログインします。
  2.  API keysページから「Create new secret key」をクリックします。
  3.  作成したAPIキーを安全な場所に保管します。

### **3.5 環境変数の設定**
*   プロジェクトのルートに、バックエンド用とフロントエンド用の `.env` ファイルを作成します。

*   **バックエンド (`functions/.env`)**
  ```
  # 使用するLLMの指定 (gemini or openai)
  LLM_PROVIDER=gemini

  # 各LLMのAPIキー
  GEMINI_API_KEY="your_gemini_api_key_here"
  OPENAI_API_KEY="your_openai_api_key_here"
  ```

*   **フロントエンド (`.env.local`)**
  ```
  # Firebaseプロジェクトの設定値 (Firebaseコンソールのプロジェクト設定からコピー)
  NEXT_PUBLIC_FIREBASE_API_KEY="your_firebase_api_key"
  NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN="your_project_id.firebaseapp.com"
  NEXT_PUBLIC_FIREBASE_PROJECT_ID="your_project_id"
  NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET="your_project_id.appspot.com"
  NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID="your_sender_id"
  NEXT_PUBLIC_FIREBASE_APP_ID="your_app_id"

  # バックエンドAPIのエンドポイント
  NEXT_PUBLIC_API_BASE_URL="http://127.0.0.1:5001/your_project_id/us-central1/api"
  ```

## **4. プロジェクト構成**

フロントエンドとバックエンドを一つのリポジトリで管理するモノレポ構成を推奨します。

```
/
├── .env.local                  # FE 環境変数
├── .firebaserc                 # Firebase プロジェクト設定
├── firebase.json               # Firebase デプロイ設定
├── package.json                # プロジェクト全体の依存関係 (lerna/nxなどで管理)
│
├── functions/                  # バックエンド (Firebase Functions)
│   ├── src/
│   │   ├── controllers/        # リクエスト/レスポンス処理
│   │   │   └── chatController.ts
│   │   │   └── reminderController.ts    # 新規: リマインド管理
│   │   ├── services/           # ビジネスロジック
│   │   │   ├── chatService.ts
│   │   │   ├── learningRecordService.ts # 新規: 学習記録生成
│   │   │   └── llm/            # LLM関連ロジック (切替可能に)
│   ├── .env                    # BE 環境変数
│   ├── package.json
│   └── tsconfig.json
│
└── web/                        # フロントエンド (Next.js)
  ├── app/
  │   ├── page.tsx             # トップページ (Home コンポーネントを import)
  │   ├── chat/
  │   │   ├── page.tsx        # AI対話画面 (Chat コンポーネントを import)
  │   │   ├── chat.tsx        # AI対話画面のコンポーネント
  │   │   └── [sessionId]/
  │   │       ├── page.tsx    # 動的セッション画面 (Session コンポーネントを import)
  │   │       └── session.tsx # 動的セッション画面のコンポーネント
  │   ├── auth/
  │   │   ├── page.tsx        # 認証関連ページ (Auth コンポーネントを import)
  │   │   └── auth.tsx        # 認証関連ページのコンポーネント
  │   ├── reminders/           # 新規: リマインド設定ページ
  │   │   ├── page.tsx        # リマインド設定画面
  │   │   └── reminders.tsx   # リマインド設定コンポーネント
  │   └── layout.tsx
  ├── components/
  │   ├── ui/                 # Shadcn/uiコンポーネント
  │   └── common/
  │       ├── ChatView.tsx
  │       ├── MessageInput.tsx
  │       ├── ReminderSettings.tsx    # 新規: リマインド設定UI
  │       └── NotificationPrompt.tsx  # 新規: 通知許可プロンプト
  ├── hooks/
  │   └── useAuth.ts          # 認証状態を管理するカスタムフック
  │   └── useReminders.ts     # 新規: リマインド管理フック
  ├── lib/
  │   ├── firebase.ts         # Firebaseクライアント初期化
  │   ├── apiClient.ts        # バックエンドAPIクライアント
  ├── store/
  │   └── chatStore.ts        # Zustandストア (チャット状態管理)
  │   └── reminderStore.ts    # 新規: リマインド状態管理
  ├── package.json
  └── tsconfig.json
```

## **4. バックエンド詳細設計 (Firebase Functions)**

### **5.1 学習記録自動生成サービス**
チャットセッション終了時に、AIを使用して学習内容を要約し、Firestoreに保存します。

*   **`functions/src/services/learningRecordService.ts`**
  ```typescript
  export class LearningRecordService {
    async generateRecord(sessionId: string): Promise<LearningRecord> {
    // セッションからメッセージを取得
    // AIで要約生成
    // Firestoreに保存
    }
  }
  ```

### **5.2 リマインド通知サービス**
エビングハウスの忘却曲線とユーザーの最近の活動に基づいて、リマインドタイミングを計算します。全ての問題に対して通知を送るのではなく、定期的に送る通知に含める問題を選択します。PWAプッシュ通知を使用します。

*   **`functions/src/services/reminderService.ts`**
  ```typescript
  export class ReminderService {
    // 忘却曲線に基づくデフォルトリマインドスケジュール（日数）
    private readonly DEFAULT_REVIEW_INTERVALS = [1, 3, 7, 14, 30];

    async scheduleReminders(userId: string): Promise<void> {
    // ユーザーの最近の活動を分析
    // 忘却曲線に基づいて優先度の高い問題を選択
    // PWAプッシュ通知をスケジュール
    }
  }
  ```

### **5.4 APIエンドポイントの実装**
Expressを用いてAPIルーティングを定義します。

*   **`functions/src/index.ts`**
  ```typescript
  import * as functions from "firebase-functions";
  import * as express from "express";
  import * as cors from "cors";
  import { createSession, postMessage } from "./controllers/chatController";
  import { getReminders, updateReminderSettings } from "./controllers/reminderController";

  const app = express();
  app.use(cors({ origin: true }));
  app.use(express.json());

  // 既存ルーティング
  app.post("/chatSessions", createSession);
  app.post("/chatSessions/:sessionId/messages", postMessage);

  // 新規ルーティング
  app.get("/reminders", getReminders);
  app.put("/reminderSettings", updateReminderSettings);

  export const api = functions.https.onRequest(app);
  ```

## **6. フロントエンド詳細設計 (Next.js)**

### **6.1 リマインド設定UI**
ユーザーがリマインド通知の設定を変更できるコンポーネントです。デフォルトの忘却曲線スケジュールを装備し、カスタマイズも可能です。PWAプッシュ通知をメインに使用します。

*   **`web/components/common/ReminderSettings.tsx`**
  ```typescript
  export const ReminderSettings: React.FC = () => {
    // リマインド設定のUI
    // デフォルトスケジュール表示（1,3,7,14,30日）
    // カスタムスケジュール設定
    // PWA通知許可のプロンプト
    // 通知方法の選択（プッシュ）
  };
  ```

### **6.2 リマインド管理フック**
リマインド関連の状態とAPI呼び出しを管理します。

*   **`web/hooks/useReminders.ts`**
  ```typescript
  export const useReminders = () => {
    // リマインド一覧の取得
    // 設定の更新
    // 通知の処理
  };
  ```

## **7. データモデル**

### **7.1 LearningRecord**
```typescript
interface LearningRecord {
  id: string;
  userId: string;
  sessionId: string;
  subject: string;
  topic: string;
  summary: string;
  duration: number; // 分
  completedAt: Date;
}
```

### **7.2 Reminder**
```typescript
interface Reminder {
  id: string;
  userId: string;
  recordId: string;
  scheduledAt: Date;
  status: 'pending' | 'sent' | 'completed';
  type: 'review' | 'practice';
}
```

### **7.3 ReminderSettings**
```typescript
interface ReminderSettings {
  userId: string;
  enabled: boolean;
  notificationMethods: ('push' | 'email')[];
  reviewIntervals: number[]; // カスタム間隔（日数）
}
```

## **7.4 画面構成**

### **7.4.1 リマインド設定画面**
- **URL**: `/reminders`
- **コンポーネント**: `web/app/reminders/page.tsx`
- **レイアウト**:
  - ヘッダー: 「リマインド設定」
  - メインコンテンツ:
  - リマインド有効/無効トグル
  - 通知方法選択（プッシュ通知、メール）
  - 忘却曲線スケジュール表示（1日後、3日後、1週間後、2週間後、1ヶ月後）
  - カスタム間隔設定オプション
  - 保存ボタン
  - フッター: ナビゲーション

### **7.4.2 通知許可プロンプト**
- **コンポーネント**: `web/components/common/NotificationPrompt.tsx`
- **表示タイミング**: 初回アクセス時または設定変更時
- **レイアウト**:
  - モーダルダイアログ
  - タイトル: 「通知を許可しますか？」
  - 説明: 「学習リマインドを受け取るために通知を有効にしてください」
  - ボタン: 「許可する」「後で」

### **7.4.3 独自カレンダー画面**
- **URL**: `/calendar`
- **コンポーネント**: `web/app/calendar/calendar.tsx`
- **レイアウト**:
  - カレンダーグリッド表示
  - 学習記録のイベント表示
  - イベント詳細ポップアップ
  - フィルター機能（教科別など）

### **7.4.4 学習記録一覧画面（拡張）**
- **既存画面拡張**: `web/app/chat/page.tsx`
- **追加要素**:
  - 学習記録タブ
  - 記録一覧（教科、トピック、完了日時）
  - リマインドステータス表示

## **7.5 データベース構成**

### **7.5.1 LearningRecordコレクション**
**パス**: `/learningRecords/{recordId}`

```javascript
{
  // ドキュメントID: 自動生成
  "userId": "string",           // ユーザーID (必須)
  "sessionId": "string",        // 関連セッションID (必須)
  "subject": "string",          // 教科 (例: "math", "science") (必須)
  "topic": "string",            // トピック (必須)
  "summary": "string",          // AI生成要約 (必須)
  "duration": "number",         // 学習時間（分） (必須)
  "completedAt": "timestamp",   // 完了日時 (必須)
  "calendarEventId": "string",  // Google CalendarイベントID (オプション)
  "createdAt": "timestamp",     // 作成日時 (必須)
  "updatedAt": "timestamp"      // 更新日時 (必須)
}
```

### **7.5.2 Reminderコレクション**
**パス**: `/reminders/{reminderId}`

```javascript
{
  // ドキュメントID: 自動生成
  "userId": "string",           // ユーザーID (必須)
  "recordId": "string",         // 関連学習記録ID (必須)
  "scheduledAt": "timestamp",   // スケジュール日時 (必須)
  "status": "string",           // ステータス ("pending", "sent", "completed") (必須)
  "type": "string"             // タイプ ("review", "practice") (必須)
}
```

### **7.5.3 ReminderSettingsコレクション**
**パス**: `/reminderSettings/{userId}`

```javascript
{
  // ドキュメントID: ユーザーID
  "enabled": "boolean",         // リマインド有効/無効 (必須)
  "notificationMethods": ["string"], // 通知方法 ["push", "email"] (必須)
  "reviewIntervals": ["number"], // カスタム間隔（日数） [1, 3, 7, 14, 30] (必須)
  "lastUpdated": "timestamp",   // 最終更新日時 (必須)
  "createdAt": "timestamp"      // 作成日時 (必須)
}
```

### **7.5.4 インデックス設計**
```javascript
// LearningRecordコレクション
[
  {
  "collectionGroup": "learningRecords",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "completedAt", "order": "DESCENDING" }
  ]
  },
  {
  "collectionGroup": "learningRecords",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "subject", "order": "ASCENDING" },
    { "fieldPath": "completedAt", "order": "DESCENDING" }
  ]
  }
]

// Reminderコレクション
[
  {
  "collectionGroup": "reminders",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "scheduledAt", "order": "ASCENDING" }
  ]
  },
  {
  "collectionGroup": "reminders",
  "queryScope": "COLLECTION",
  "fields": [
    { "fieldPath": "userId", "order": "ASCENDING" },
    { "fieldPath": "status", "order": "ASCENDING" },
    { "fieldPath": "scheduledAt", "order": "ASCENDING" }
  ]
  }
]
```

### **7.5.5 セキュリティルール**
```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
  // 既存ルール...

  // LearningRecordコレクション
  match /learningRecords/{recordId} {
    allow read, write: if request.auth != null
    && request.auth.uid == resource.data.userId;
    allow create: if request.auth != null
    && request.auth.uid == request.resource.data.userId;
  }

  // Reminderコレクション
  match /reminders/{reminderId} {
    allow read, write: if request.auth != null
    && request.auth.uid == resource.data.userId;
    allow create: if request.auth != null
    && request.auth.uid == request.resource.data.userId;
  }

  // ReminderSettingsコレクション
  match /reminderSettings/{userId} {
    allow read, write: if request.auth != null
    && request.auth.uid == userId;
  }
  }
}
```

## **16. 実装ステップ**

実装を機能ごとに順番に進めることで、段階的な開発とテストを可能にします。各ステップは独立して実装可能で、前のステップの完了を前提とします。

### **ステップ1: データベース設計と基本設定 (1-2日)**
- LearningRecord, Reminder, ReminderSettingsコレクションの作成
- インデックス設定
- セキュリティルール更新
- 環境変数の設定

### **ステップ2: 学習記録自動生成機能 (2-3日)**
- LearningRecordServiceの実装
- AI要約生成機能
- チャットセッション終了時の自動記録トリガー
- Firestore保存機能

### **ステップ3: リマインド通知システム (3-4日)**
- ReminderServiceの実装（忘却曲線 + 活動分析）
- PWAプッシュ通知統合
- 通知スケジューリング機能
- 通知内問題表示機能（PWA簡易UIまたは問題だけ）

### **ステップ4: APIエンドポイント実装 (2-3日)**
- ReminderControllerの実装
- APIルーティング設定
- エラーハンドリング

### **ステップ5: フロントエンドUI実装 (3-4日)**
- ReminderSettingsコンポーネント
- NotificationPromptコンポーネント
- リマインド設定画面

### **ステップ6: 統合とテスト (2-3日)**
- 全体フロー統合
- 単体テスト作成
- 統合テスト作成
- E2Eテスト作成

### **ステップ7: デプロイとリリース (1-2日)**
- Firebase Functionsデプロイ
- Vercelデプロイ
- 環境変数設定
- リリース確認

## **17. 実装計画**

| ステップ | 対応するフォルダ | 対応するファイル | 修正内容の概要 | 見積もり時間 |
| -------- | ---------------- | ---------------- | -------------- | ------------ |
| ステップ1 | docs/design/ | database-design.md | LearningRecord, Reminder, ReminderSettingsコレクションの設計追加 | 2時間 |
| ステップ1 | docs/design/ | database-design.md | インデックスとセキュリティルールの設計追加 | 2時間 |
| ステップ2 | functions/src/services/ | learningRecordService.ts | 学習記録の自動生成とAI要約機能の実装 | 4時間 |
| ステップ2 | functions/src/services/ | learningRecordService.ts | Firestore保存とトリガー機能の実装 | 4時間 |
| ステップ3 | functions/src/services/ | reminderService.ts | エビングハウスの忘却曲線に基づくスケジュール計算 | 4時間 |
| ステップ3 | functions/src/services/ | reminderService.ts | Firebase Cloud Messaging統合と通知送信 | 6時間 |
| ステップ4 | functions/src/controllers/ | reminderController.ts | リマインド設定取得・更新のAPIエンドポイント実装 | 4時間 |
| ステップ4 | functions/src/ | index.ts | 新規APIルーティングの設定 | 2時間 |
| ステップ5 | web/components/common/ | ReminderSettings.tsx | リマインド設定UIコンポーネントの実装 | 4時間 |
| ステップ5 | web/components/common/ | NotificationPrompt.tsx | 通知許可プロンプトコンポーネントの実装 | 2時間 |
| ステップ5 | web/hooks/ | useReminders.ts | リマインド状態管理とAPI連携フックの実装 | 4時間 |
| ステップ5 | web/store/ | reminderStore.ts | リマインド関連の状態管理ストアの実装 | 2時間 |
| ステップ6 | docs/design/ | test-design.md | 新機能の単体・統合・E2Eテストケース追加 | 4時間 |
| ステップ6 | functions/src/ | 各種テストファイル | バックエンド機能のテスト実装 | 6時間 |
| ステップ6 | web/ | 各種テストファイル | フロントエンド機能のテスト実装 | 6時間 |
| ステップ7 | functions/ | package.json, 設定ファイル | Firebase Functionsデプロイ設定 | 2時間 |
| ステップ7 | web/ | package.json, 設定ファイル | Vercelデプロイ設定 | 2時間 |
| ステップ7 | プロジェクトルート | .envファイル | 本番環境変数の設定 | 2時間 |

## **18. データ量と料金概算**

#### **18.1 データ量見積もり**
- **想定ユーザー数**: 1,000人（MVP規模）
- **1ユーザーあたりの平均データ**:
  - 学習記録: 30件/月（1日1件）
  - リマインド: 90件/月（1記録あたり3件）
  - 合計: 120件/月/ユーザー

- **総データ量**: 120,000件/月（1,000ユーザー × 120件）

#### **18.2 Firestore料金概算**
- **ドキュメント書き込み**: 120,000件/月 × $0.18/100,000件 = $0.22
- **ドキュメント読み取り**: 360,000件/月（書き込みの3倍想定） × $0.06/100,000件 = $0.22
- **ストレージ**: 50MB/月 × $0.18/GB = $0.009
- **ネットワーク**: 最小料金
- **月額合計**: 約$0.44（無料枠内で収まる見込み）

#### **18.3 その他の料金**
- **Gemini API**: 10,000リクエスト/月 × $0.002/リクエスト = $20
- **Firebase Hosting**: 無料
- **Vercel**: 無料枠内で収まる

#### **18.4 スケーリング時の考慮**
- ユーザー数10,000人時: 月額約$50-100
- 最適化により無料枠を最大限活用可能
